import{a9 as tt,B as et,a8 as it,a6 as U,n as W,aC as nt,P as st,aD as rt,T as L,aE as R,az as J,aF as ot,aA as at,e as ft,i as lt,v as ht}from"./index-DAa9yKAB.js";import{T as gt}from"./THistPainter-DJAmNO-k.js";import{b as Q}from"./hist3d-BC5Tno_J.js";import{p as xt,g as dt}from"./func-CztLwFD8.js";import"./TPavePainter-DMWA3hUD.js";import"./latex3d-BISPawP1.js";import"./TH2Painter-Ba0oelVz.js";class V extends gt{#t;getDimension(){return 3}scanContent(t){if(t&&this.nbinsx&&this.nbinsy&&this.nbinsz)return;const n=this.getHisto();this.extractAxesProperties(3),this.gminbin=this.gmaxbin=n.getBinContent(1,1,1),this.gminposbin=null;for(let e=0;e<this.nbinsx;++e)for(let i=0;i<this.nbinsy;++i)for(let l=0;l<this.nbinsz;++l){const f=n.getBinContent(e+1,i+1,l+1);f<this.gminbin?this.gminbin=f:f>this.gmaxbin&&(this.gmaxbin=f),f>0&&(this.gminposbin===null||this.gminposbin>f)&&(this.gminposbin=f)}this.gminposbin===null&&this.gmaxbin>0&&(this.gminposbin=this.gmaxbin*1e-4),this.draw_content=this.gmaxbin||this.gminbin,this.transferFunc=this.findFunction(tt,"TransferFunction"),this.transferFunc?.SetBit(et(9),!0)}countStat(t,n){const e=this.getHisto(),i=e.fXaxis,l=e.fYaxis,f=e.fZaxis,h=this.getSelectIndex("x","left"),B=this.getSelectIndex("x","right"),g=this.getSelectIndex("y","left"),x=this.getSelectIndex("y","right"),r=this.getSelectIndex("z","left"),T=this.getSelectIndex("z","right"),S=this.getFramePainter(),s={name:e.fName,entries:0,eff_entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0,skewx:0,skewy:0,skewz:0,skewd:0,kurtx:0,kurty:0,kurtz:0,kurtd:0},M=Math.abs(e.fTsumw)>1e-300&&!S.isAxisZoomed("x")&&!S.isAxisZoomed("y")&&!S.isAxisZoomed("z");let p,b,C,G,E,k,$,I,P,w,d=0,j=0,O=0,Y=0,Z=0,K=0,a=0,m=0;for(lt(t)||(t=null),p=0;p<this.nbinsx+2;++p)for(G=i.GetBinCoord(p-.5),E=p<h?0:p>B?2:1,b=0;b<this.nbinsy+2;++b)for(k=l.GetBinCoord(b-.5),$=b<g?0:b>x?2:1,C=0;C<this.nbinsz+2;++C)I=f.GetBinCoord(C-.5),P=C<r?0:C>T?2:1,!(t&&!t(G,k,I))&&(w=e.getBinContent(p,b,C),s.entries+=w,!M&&E===1&&$===1&&P===1&&(d+=w,j+=w*w,O+=G*w,Y+=k*w,Z+=I*w,K+=G**2*w,a+=k**2*w,m+=I**2*w));if(M&&(d=e.fTsumw,j=e.fTsumw2,O=e.fTsumwx,K=e.fTsumwx2,Y=e.fTsumwy,a=e.fTsumwy2,Z=e.fTsumwz,m=e.fTsumwz2),Math.abs(d)>1e-300&&(s.meanx=O/d,s.meany=Y/d,s.meanz=Z/d,s.rmsx=Math.sqrt(Math.abs(K/d-s.meanx*s.meanx)),s.rmsy=Math.sqrt(Math.abs(a/d-s.meany*s.meany)),s.rmsz=Math.sqrt(Math.abs(m/d-s.meanz*s.meanz))),s.integral=d,e.fEntries>0&&(s.entries=e.fEntries),s.eff_entries=j?d*d/j:Math.abs(d),n&&!this.isTH2Poly()){let _=0,y=0,o=0,F=0,c=0,z=0,u=0;for(p=h;p<B;++p)for(G=i.GetBinCoord(p+.5),b=g;b<x;++b)for(k=l.GetBinCoord(b+.5),C=r;C<T;++C){if(I=f.GetBinCoord(C+.5),t&&!t(G,k,I))continue;const X=e.getBinContent(p+1,b+1,C+1);u+=X,_+=X*Math.pow(G-s.meanx,3),y+=X*Math.pow(k-s.meany,3),o+=X*Math.pow(I-s.meany,3),F+=X*Math.pow(G-s.meanx,4),c+=X*Math.pow(k-s.meany,4),z+=X*Math.pow(k-s.meany,4)}const v=Math.pow(s.rmsx,3),A=Math.pow(s.rmsy,3),D=Math.pow(s.rmsz,3),q=Math.pow(s.rmsx,4),H=Math.pow(s.rmsy,4),N=Math.pow(s.rmsz,4);u*v&&(s.skewx=_/(u*v)),u*A&&(s.skewy=y/(u*A)),u*D&&(s.skewz=o/(u*D)),s.skewd=s.eff_entries>0?Math.sqrt(6/s.eff_entries):0,u*q&&(s.kurtx=F/(u*q)-3),u*H&&(s.kurty=c/(u*H)-3),u*N&&(s.kurtz=z/(u*N)-3),s.kurtd=s.eff_entries>0?Math.sqrt(24/s.eff_entries):0}return s}fillStatistic(t,n,e){if(this.isIgnoreStatsFill())return!1;n===1&&(n=1111);const i=n%10,l=Math.floor(n/10)%10,f=Math.floor(n/100)%10,h=Math.floor(n/1e3)%10,B=Math.floor(n/1e6)%10,g=Math.floor(n/1e7)%10,x=Math.floor(n/1e8)%10,r=this.countStat(void 0,g>0||x>0);return t.clearPave(),i>0&&t.addText(r.name),l>0&&t.addText("Entries = "+t.format(r.entries,"entries")),f>0&&(t.addText("Mean x = "+t.format(r.meanx)),t.addText("Mean y = "+t.format(r.meany)),t.addText("Mean z = "+t.format(r.meanz))),h>0&&(t.addText("Std Dev x = "+t.format(r.rmsx)),t.addText("Std Dev y = "+t.format(r.rmsy)),t.addText("Std Dev z = "+t.format(r.rmsz))),B>0&&t.addText("Integral = "+t.format(r.integral,"entries")),g===2?(t.addText(`Skewness x = ${t.format(r.skewx)} #pm ${t.format(r.skewd)}`),t.addText(`Skewness y = ${t.format(r.skewy)} #pm ${t.format(r.skewd)}`),t.addText(`Skewness z = ${t.format(r.skewz)} #pm ${t.format(r.skewd)}`)):g>0&&(t.addText(`Skewness x = ${t.format(r.skewx)}`),t.addText(`Skewness y = ${t.format(r.skewy)}`),t.addText(`Skewness z = ${t.format(r.skewz)}`)),x===2?(t.addText(`Kurtosis x = ${t.format(r.kurtx)} #pm ${t.format(r.kurtd)}`),t.addText(`Kurtosis y = ${t.format(r.kurty)} #pm ${t.format(r.kurtd)}`),t.addText(`Kurtosis z = ${t.format(r.kurtz)} #pm ${t.format(r.kurtd)}`)):x>0&&(t.addText(`Kurtosis x = ${t.format(r.kurtx)}`),t.addText(`Kurtosis y = ${t.format(r.kurty)}`),t.addText(`Kurtosis z = ${t.format(r.kurtz)}`)),e&&t.fillFunctionStat(this.findFunction(it),e,3),!0}getBinTooltips(t,n,e){const i=[],l=this.getHisto();i.push(this.getObjectHint(),`x = ${this.getAxisBinTip("x",l.fXaxis,t)}  xbin=${t+1}`,`y = ${this.getAxisBinTip("y",l.fYaxis,n)}  ybin=${n+1}`,`z = ${this.getAxisBinTip("z",l.fZaxis,e)}  zbin=${e+1}`);const f=l.getBinContent(t+1,n+1,e+1);if(f===Math.round(f)?i.push(`entries = ${f}`):i.push(`entries = ${U(f,W.fStatFormat)}`),this.matchObjectType(nt)){const h=l.getBinError(l.getBin(t+1,n+1,e+1));i.push("error = "+(h===Math.round(h)?h.toString():U(h,W.fPaintTextFormat)))}return i}draw3DScatter(){const t=this.getObject(),n=this.getFramePainter(),e=this.getSelectIndex("x","left",.5),i=this.getSelectIndex("x","right",0),l=this.getSelectIndex("y","left",.5),f=this.getSelectIndex("y","right",0),h=this.getSelectIndex("z","left",.5),B=this.getSelectIndex("z","right",0);let g,x,r,T;if(i<=e||f<=l||B<=h)return Promise.resolve(!0);const S=this.gmaxbin>1e3?1e3/this.gmaxbin:1,s=Math.max(0,this.gminbin);let M=0,p=0;for(g=e;g<i;++g)for(x=l;x<f;++x)for(r=h;r<B;++r)T=t.getBinContent(g+1,x+1,r+1),p+=T,T>s&&(M+=Math.round(T*S));if(M>(n.webgl?1e5:3e4))return!1;const b=new st(M,n.webgl,n.size_x3d/200),C=new Int32Array(M),G=new rt(p);let E=0;for(g=e;g<i;++g)for(x=l;x<f;++x)for(r=h;r<B;++r){if(T=t.getBinContent(g+1,x+1,r+1),T<=s)continue;const k=Math.round(T*S);for(let $=0;$<k;++$){const I=t.fXaxis.GetBinCoord(g+G.random()),P=t.fYaxis.GetBinCoord(x+G.random()),w=t.fZaxis.GetBinCoord(r+G.random());C[E++]=t.getBin(g+1,x+1,r+1),b.addPoint(n.grx(I),n.gry(P),n.grz(w))}}return b.createPoints({color:this.getColor(t.fMarkerColor)}).then(k=>(n.add3DMesh(k),k.bins=C,k.painter=this,k.tip_color=t.fMarkerColor===3?16711680:65280,k.tooltip=function($){const I=Math.floor($.index/this.nvertex);if(I<0||I>=this.bins.length)return null;const P=this.painter,w=P.getHisto(),d=P.get3DToolTip(this.bins[I]);return d.x1=n.grx(w.fXaxis.GetBinLowEdge(d.ix)),d.x2=n.grx(w.fXaxis.GetBinLowEdge(d.ix+1)),d.y1=n.gry(w.fYaxis.GetBinLowEdge(d.iy)),d.y2=n.gry(w.fYaxis.GetBinLowEdge(d.iy+1)),d.z1=n.grz(w.fZaxis.GetBinLowEdge(d.iz)),d.z2=n.grz(w.fZaxis.GetBinLowEdge(d.iz+1)),d.color=this.tip_color,d.opacity=.3,d},!0))}async draw3DBins(){if(!this.draw_content)return!1;const t=this.getOptions();let n=t.BoxStyle;if(!n&&t.Scat){const a=this.draw3DScatter();if(a!==!1)return a;n=12}else!n&&!t.GLBox&&!t.GLColor&&!t.Lego&&(n=12);const e=this.getHisto(),i=this.getFramePainter();let l=!1,f=!1,h=!1,B=1,g=-1,x=this.getPadPainter()?.getRootPad()?.fLogv,r=!0,T=0,S=this.getColor(e.fFillColor),s=.5,M;if(!n&&t.Lego&&(n=t.Lego===1?10:t.Lego),t.GLBox===11||t.GLBox===12)s=.4,l=!0,t.GLBox===12&&(h=!0),M=new L.SphereGeometry(.5,i.webgl?16:8,i.webgl?12:6),M.applyMatrix4(new L.Matrix4().makeRotationX(Math.PI/2)),M.computeVertexNormals();else{const a=R.Indexes,m=R.Normals,_=R.Vertices,y=a.length*3,o=new Float32Array(y),F=new Float32Array(y);for(let c=0,z=-3;c<a.length;++c){const u=_[a[c]];o[c*3]=u.x-.5,o[c*3+1]=u.y-.5,o[c*3+2]=u.z-.5,c%6===0&&(z+=3),F[c*3]=m[z],F[c*3+1]=m[z+1],F[c*3+2]=m[z+2]}f=!0,n===12?h=!0:n===13?(h=!0,f=!1):t.GLColor&&(h=!0,B=.5,r=!1,f=!1,g=0,l=!0),M=new L.BufferGeometry,M.setAttribute("position",new L.BufferAttribute(o,3)),M.setAttribute("normal",new L.BufferAttribute(F,3))}this.#t=n,r&&x?this.gminposbin&&this.gmaxbin>this.gminposbin?(T=Math.log(this.gminposbin)-.1,r=1/(Math.log(this.gmaxbin)-T)):(x=0,r=1):r&&(r=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);const p=a=>{if(g>=0&&a<g)return 0;if(!r)return 1;if(x){if(a<=0)return 0;a=Math.log(a)-T}return Math.pow(Math.abs(a*r),.3333)},b=this.getSelectIndex("x","left",.5),C=this.getSelectIndex("x","right",0),G=this.getSelectIndex("y","left",.5),E=this.getSelectIndex("y","right",0),k=this.getSelectIndex("z","left",.5),$=this.getSelectIndex("z","right",0);if(C<=b||E<=G||$<=k)return!1;const I=h?this.getContour():null,P=h?this.getHistPalette():null,w=[],d=[],j=[],O=[],Y=[],Z=this.transferFunc&&xt(this.transferFunc,!0)?this.transferFunc:null;for(let a=b;a<C;++a){const m=i.grx(e.fXaxis.GetBinLowEdge(a+1)),_=i.grx(e.fXaxis.GetBinLowEdge(a+2));for(let y=G;y<E;++y){const o=i.gry(e.fYaxis.GetBinLowEdge(y+1)),F=i.gry(e.fYaxis.GetBinLowEdge(y+2));for(let c=k;c<$;++c){const z=e.getBinContent(a+1,y+1,c+1);if(!t.GLColor&&(z===0||z<this.gminbin))continue;const u=p(z);if(u<.001)continue;if(h){const q=I.getPaletteIndex(P,z);if(q===null)continue;if(d.push(P.getColor(q)),Z){const H=dt(Z,z,!1)*3;Y.push(!H||H<0?0:H>1?1:H)}}const v=i.grz(e.fZaxis.GetBinLowEdge(c+1)),A=i.grz(e.fZaxis.GetBinLowEdge(c+2));j.push(e.getBin(a+1,y+1,c+1));const D=new L.Matrix4;D.scale(new L.Vector3((_-m)*u,(F-o)*u,(A-v)*u)),D.setPosition((_+m)/2,(F+o)/2,(A+v)/2),w.push(D),z<0&&O.push(D)}}}function K(a){let m=this.binid;if(m===void 0){if(a.instanceId===void 0||a.instanceId>=this.bins.length)return;m=this.bins[a.instanceId]}const _=this.painter,y=_.getHisto(),o=_.get3DToolTip(m),F=i.grx(y.fXaxis.GetBinCoord(o.ix-1)),c=i.grx(y.fXaxis.GetBinCoord(o.ix)),z=i.gry(y.fYaxis.GetBinCoord(o.iy-1)),u=i.gry(y.fYaxis.GetBinCoord(o.iy)),v=i.grz(y.fZaxis.GetBinCoord(o.iz-1)),A=i.grz(y.fZaxis.GetBinCoord(o.iz)),D=this.get_weight(o.value)*this.tipscale;return o.x1=(c+F)/2-(c-F)*D,o.x2=(c+F)/2+(c-F)*D,o.y1=(u+z)/2-(u-z)*D,o.y2=(u+z)/2+(u-z)*D,o.z1=(A+v)/2-(A-v)*D,o.z2=(A+v)/2+(A-v)*D,o.color=this.tip_color,o}if(h&&(Z||B!==1))for(let a=0;a<w.length;++a){const m=Z?Y[a]:B,_=new L.Color(d[a]),y=l?new L.MeshLambertMaterial({color:_,opacity:m,transparent:m<1,vertexColors:!1}):new L.MeshBasicMaterial({color:_,opacity:m,transparent:m<1,vertexColors:!1}),o=new L.Mesh(M,y);o.applyMatrix4(w[a]),o.painter=this,o.binid=j[a],o.tipscale=s,o.tip_color=e.fFillColor===3?16711680:65280,o.get_weight=p,o.tooltip=K,i.add3DMesh(o)}else{h&&(S=new L.Color(1,1,1));const a=l?new L.MeshLambertMaterial({color:S,vertexColors:!1}):new L.MeshBasicMaterial({color:S,vertexColors:!1}),m=new L.InstancedMesh(M,a,w.length);for(let _=0;_<w.length;++_)m.setMatrixAt(_,w[_]),h&&m.setColorAt(_,new L.Color(d[_]));m.painter=this,m.bins=j,m.tipscale=s,m.tip_color=e.fFillColor===3?16711680:65280,m.get_weight=p,m.tooltip=K,i.add3DMesh(m)}if(f){let m=function(_,y){if(!y)return;const o=new Float32Array(y.length*_.length*3);for(let F=0,c=0;F<y.length;++F){const z=y[F].elements;for(let u=0;u<_.length;++u,c+=3){const v=R.Vertices[_[u]];o[c]=z[12]+(v.x-.5)*z[0],o[c+1]=z[13]+(v.y-.5)*z[5],o[c+2]=z[14]+(v.z-.5)*z[10]}}i.add3DMesh(ht(o,a))};const a=new L.LineBasicMaterial({color:this.getColor(e.fLineColor)});m(R.Segments,w),m(R.Crosses,O)}return!0}async redraw(t){const n=this.getFramePainter(),e=this.getOptions();let i=Promise.resolve(!0),l=!0;if(t==="resize"){const f=n.resize3D();f!==1&&(l=!1,f&&n.render3D())}return l&&(i=Q(this,J,e.Render3D).then(()=>this.draw3DBins()).then(()=>{n.render3D(),this.updateStatWebCanvas(),n.addKeysHandler()})),this.isMainPainter()&&(i=i.then(()=>this.drawColorPalette(e.Zscale&&(this.#t===12||this.#t===13||e.GLBox===12)))),i.then(()=>this.updateFunctions()).then(()=>this.updateHistTitle()).then(()=>this)}fillToolbar(){const t=this.getPadPainter();t&&(t.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&t.addPadButton("statbox","Toggle stat box","ToggleStatBox"),t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}canZoomInside(t,n,e){let i=this.getHisto();return i&&(i=i[`f${t.toUpperCase()}axis`]),!i||i.FindBin(e,.5)-i.FindBin(n,0)>1}autoZoom(){const t=this.getSelectIndex("x","left"),n=this.getSelectIndex("x","right"),e=this.getSelectIndex("y","left"),i=this.getSelectIndex("y","right"),l=this.getSelectIndex("z","left"),f=this.getSelectIndex("z","right"),h=this.getObject();let B,g,x;if(t===n||e===i||l===f)return;let r=h.getBinContent(t+1,e+1,l+1);for(B=t;B<n;++B)for(g=e;g<i;++g)for(x=l;x<f;++x)r=Math.min(r,h.getBinContent(B+1,g+1,x+1));if(r>0)return;let T=n,S=t,s=i,M=e,p=f,b=l;for(B=t;B<n;++B)for(g=e;g<i;++g)for(x=l;x<f;++x)h.getBinContent(B+1,g+1,x+1)>r&&(B<T&&(T=B),B>=S&&(S=B+1),g<s&&(s=g),g>=M&&(M=g+1),x<p&&(p=x),x>=b&&(b=x+1));let C,G,E,k,$,I,P=!1;if(T===S-1&&T>t+1&&S<n-1&&(T--,S++),s===M-1&&s>e+1&&M<i-1&&(s--,M++),p===b-1&&p>l+1&&b<f-1&&(p--,b++),(T>t||S<n)&&T<S-1&&(C=h.fXaxis.GetBinLowEdge(T+1),G=h.fXaxis.GetBinLowEdge(S+1),P=!0),(s>e||M<i)&&s<M-1&&(E=h.fYaxis.GetBinLowEdge(s+1),k=h.fYaxis.GetBinLowEdge(M+1),P=!0),(p>l||b<f)&&p<b-1&&($=h.fZaxis.GetBinLowEdge(p+1),I=h.fZaxis.GetBinLowEdge(b+1),P=!0),P)return this.getFramePainter().zoom(C,G,E,k,$,I)}fillHistContextMenu(t){const n=this.getSupportedDrawOptions();t.addDrawMenu("Draw with",n,e=>{if(e.indexOf(ot)===0)return this.showInspector(e);this.decodeOptions(e),this.interactiveRedraw(!0,"drawopt")})}static async build3d(t,n){const e=new V(null,t);e.mode3d=!0,e.decodeOptions(n),e.scanContent();const i=new at(null,null);return e.getFramePainter=()=>i,Q(e,J).then(()=>e.draw3DBins()).then(()=>i.create3DScene(-1,!0))}static async draw(t,n,e){const i=new V(t,n);return i.mode3d=!0,ft(i,"3d").then(()=>(i.setAsMainPainter(),i.decodeOptions(e),i.checkPadRange(),i.scanContent(),i.createStat(),i.redraw())).then(()=>i.drawFunctions()).then(()=>(i.fillToolbar(),i))}}export{V as TH3Painter};
