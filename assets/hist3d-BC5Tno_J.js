import{aG as ve,K as Oe,T as m,aE as ge,H as ae,aH as Ee,v as ie,w as He,i as le,aI as Ve,aJ as Ne,aK as $e,aL as Ze,aM as we,aN as Ge,aO as Ye,aP as Xe,aQ as Ue,aR as We,aS as Ke,aT as Je}from"./index-DAa9yKAB.js";import{createLatexGeometry as ze}from"./latex3d-BISPawP1.js";import{k as Le,a as qe,b as Qe,c as et,d as tt}from"./THistPainter-DJAmNO-k.js";import{b as je,c as it}from"./TH2Painter-Ba0oelVz.js";function Ae(e,r,i=!1,a=!1){let t;if(r?.children)for(let h=0;h<r.children.length&&(t=r.children[h],!t.axis_draw);++h)t=void 0;if(!t)return;if(!e){r.remove(t);return}const o=e.position;let d=1;o.x<0&&o.y>=0?d=2:o.x>=0&&o.y>=0?d=3:o.x>=0&&o.y<0&&(d=4);const x=(h,_)=>(h<=d&&(h+=4),h>d&&h<d+_),n=h=>{for(let _=0;_<h.children?.length;++_)h.children[_].zoom!==void 0&&(h.children[_].zoom_disabled=!h.visible)};for(let h=0;h<t.children.length;++h){const _=t.children[h];if(_.grid)_.visible=a&&x(_.grid,3);else if(_.zid)_.visible=x(_.zid,2),n(_);else if(_.xyid)_.visible=x(_.xyid,3),n(_);else if(_.xyboxid){let B=5,z=0;a&&!i?(B=3,z=-2):i&&!a?B=3:!i&&!a&&(B=_.bottom?3:0),_.visible=x(_.xyboxid+z,B),!_.visible&&_.bottom&&a&&(_.visible=x(_.xyboxid,3))}else if(_.zboxid){let B=2,z=0;i&&a?B=5:a&&!i?B=4:!a&&i&&(z=-2,B=4),_.visible=x(_.zboxid+z,B)}}}function Be(e,r,i,a){if(e.options.System===Le)return r;const t=e.getFramePainter();let o=1/t.size_x3d,d=1/t.size_y3d;if(i&&a&&(o*=i/(i-1),d*=a/(a-1)),e.options.System===qe)for(let x=0;x<r.length;x+=3){const n=(1-r[x]*o)*Math.PI,h=.5+.5*r[x+1]*d;r[x]=Math.cos(n)*h*t.size_x3d,r[x+1]=Math.sin(n)*h*t.size_y3d}else if(e.options.System===Qe)for(let x=0;x<r.length;x+=3){const n=(1-r[x]*o)*Math.PI,h=.5+r[x+2]/t.size_z3d/4;r[x]=Math.cos(n)*h*t.size_x3d,r[x+2]=(1+Math.sin(n)*h)*t.size_z3d}else if(e.options.System===et)for(let x=0;x<r.length;x+=3){const n=(1+r[x]*o)*Math.PI,h=r[x+1]*d*Math.PI,_=.5+r[x+2]/t.size_z3d/4;r[x]=_*Math.cos(h)*Math.cos(n)*t.size_x3d,r[x+1]=_*Math.cos(h)*Math.sin(n)*t.size_y3d,r[x+2]=(1+_*Math.sin(h))*t.size_z3d}else if(e.options.System===tt)for(let x=0;x<r.length;x+=3){const n=(1-r[x]*o)*Math.PI,h=r[x+1]*d*Math.PI,_=.5+r[x+2]/t.size_z3d/4;r[x]=_*Math.cos(n)*t.size_x3d,r[x+1]=_*Math.sin(h)/Math.cos(h)*t.size_y3d/2,r[x+2]=(1+_*Math.sin(n))*t.size_z3d}return r}function Ce(e,r,i,a,t){const o=new m.BufferGeometry;return e.options.System===Le?(o.setAttribute("position",new m.BufferAttribute(r,3)),i?o.setAttribute("normal",new m.BufferAttribute(i,3)):o.computeVertexNormals()):(Be(e,r,a,t),o.setAttribute("position",new m.BufferAttribute(r,3)),o.computeVertexNormals()),o}function Ie(e,r){e.camera&&(e.scene.remove(e.camera),we(e.camera),delete e.camera),r?e.camera=new m.OrthographicCamera(-1.3*e.size_x3d,1.3*e.size_x3d,2.3*e.size_z3d,-.7*e.size_z3d,.001,40*e.size_z3d):e.camera=new m.PerspectiveCamera(45,e.scene_width/e.scene_height,1,40*e.size_z3d),e.camera.up.set(0,0,1),e.pointLight=new m.DirectionalLight(16777215,3),e.pointLight.position.set(e.size_x3d/2,e.size_y3d/2,e.size_z3d/2),e.camera.add(e.pointLight),e.lookat=new m.Vector3(0,0,r?.3*e.size_z3d:.8*e.size_z3d),e.scene.add(e.camera)}function pe(e,r){const i=e.getPadPainter()?.getRootPad(!0),a=e.camera.isOrthographicCamera?1:1.4;let t=Math.max(.75*e.size_x3d,e.size_z3d),o=Math.max(.75*e.size_y3d,e.size_z3d),d=null;if(r&&(d=new m.Vector3,t===o?d.set(-1.6*t,-3.5*o,a*e.size_z3d):t>o?d.set(-2*t,-3.5*o,a*e.size_z3d):d.set(-3.5*t,-2*o,a*e.size_z3d)),i&&(r||!e.zoomChangedInteractive())&&Number.isFinite(i.fTheta)&&Number.isFinite(i.fPhi)&&(i.fTheta!==e.camera_Theta||i.fPhi!==e.camera_Phi)){d||(d=new m.Vector3),t=3*Math.max(e.size_x3d,e.size_z3d),o=3*Math.max(e.size_y3d,e.size_z3d);const x=(270-i.fPhi)/180*Math.PI,n=(i.fTheta-10)/180*Math.PI;d.set(t*Math.cos(x)*Math.cos(n),o*Math.sin(x)*Math.cos(n),e.size_z3d+(a-.9)*(t+o)*Math.sin(n))}return d}function De(e,r){const i=pe(e,r);if(i&&(e.camera.position.copy(i),r=!0),r&&e.camera.lookAt(e.lookat),r&&e.camera.isOrthographicCamera&&e.scene_width&&e.scene_height){const a=e.scene_width/e.scene_height,t=e.camera.right-e.camera.left,o=e.camera.top-e.camera.bottom;if(a>t/o){const d=(e.camera.right+e.camera.left)/2;e.camera.left=d-o*a/2,e.camera.right=d+o*a/2}else{const d=(e.camera.top+e.camera.bottom)/2;e.camera.top=d+t/a/2,e.camera.bottom=d-t/a/2}}e.camera.updateProjectionMatrix()}function st(e){const r=e.camera.position,i=e.lookat,a=r.distanceTo(i),t=Math.sqrt((r.x-i.x)**2+(r.y-i.y)**2),o=Math.atan2((r.z-i.z)/a,t/a)/Math.PI*180,d=270-Math.atan2((r.y-i.y)/t,(r.x-i.x)/t)/Math.PI*180,x=e.getPadPainter()?.getRootPad(!0);e.camera_Phi=d>=360?d-360:d,e.camera_Theta=o,x&&Number.isFinite(e.camera_Phi)&&Number.isFinite(e.camera_Theta)&&(x.fPhi=e.camera_Phi,x.fTheta=e.camera_Theta)}function Re(e){e.control=Je(e,e.camera,e.scene,e.renderer,e.lookat);const r=e,i=e.getMainPainter();if(e.access3dKind()===ve.Embed3D.Embed){const a=e.getCanvPainter()?.getPadScale();a&&e.control.tooltip?.setScale(a)}e.control.processMouseMove=function(a){let t=null,o=null,d=null;const x=r.isTooltipAllowed();for(let n=0;n<a.length;++n)if(x&&le(a[n].object?.tooltip)){if(t=a[n].object.tooltip(a[n]),t){o=a[n].object;break}}else a[n].object?.zoom&&!d&&(d=a[n].object);if(t&&!t.use_itself){const n=1e-4*r.size_x3d,h=1e-4*r.size_y3d,_=1e-4*r.size_z3d;(t.x1>t.x2||t.y1>t.y2||t.z1>t.z2)&&console.warn("check 3D hints coordinates"),t.x1-=n,t.x2+=n,t.y1-=h,t.y2+=h,t.z1-=_,t.z2+=_}if(r.highlightBin3D(t,o),!t&&d&&le(r.get3dZoomCoord)){let n=d.zoom;const h=d.globalIntersect(this.raycaster),_=r.get3dZoomCoord(h,n);return n==="z"&&d.use_y_for_z&&(n="y"),{name:n,title:"axis object",line:n+" : "+r.axisAsText(n,_),only_status:!0}}return t?.lines?t:""},e.control.processMouseLeave=function(){r.highlightBin3D(null)},e.control.contextMenu=function(a,t){let o="painter",d=i;if(t)for(let n=0;n<t.length;++n){const h=t[n].object;if(h.zoom){o=h.zoom,d=null;break}if(le(h.painter?.fillContextMenu)){d=h.painter;break}}const x=i.getFramePainter();le(x?.showContextMenu)&&x.showContextMenu(o,a,d)}}function nt(e,r,i,a){if(e===-1){if(!this.mode3d)return;if(!le(this.clear3dCanvas)){console.error(`Strange, why mode3d=${this.mode3d} is configured!`);return}const d=r?this.toplevel:null;return d&&(this.scene?.remove(d),this.toplevel=null),Ae(null,this.toplevel),this.clear3dCanvas(),we(this.scene),this.control?.cleanup(),Ge(this.renderer),delete this.size_x3d,delete this.size_y3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1,this.getG()&&!r&&this.createFrameG(),d}if(this.mode3d=!0,"toplevel"in this){this.scene.remove(this.toplevel),we(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control?.hideTooltip();const d=new m.Object3D;return this.scene.add(d),this.toplevel=d,this.resize3D(),De(this,!1),Promise.resolve(!0)}e=Ye(e,this.isBatchMode()),Xe(this);const t=this.getSizeFor3d(void 0,e);this.size_z3d=100,this.x3dscale=r||1,this.y3dscale=i||1;const o=t.height>10&&t.width>10?Math.round(t.width/t.height*this.size_z3d):this.size_z3d;return this.size_x3d=o*this.x3dscale,this.size_y3d=o*this.y3dscale,Ue().then(()=>(this.scene=new m.Scene,this.toplevel=new m.Object3D,this.scene.add(this.toplevel),this.scene_width=t.width,this.scene_height=t.height,this.scene_x=t.x??0,this.scene_y=t.y??0,this.camera_Phi=30,this.camera_Theta=30,Ie(this,a),De(this,!0),We(this.scene_width,this.scene_height,e))).then(d=>(this.renderer=d,d?(this.webgl=d.jsroot_render3d===ve.Render3D.WebGL,this.add3dCanvas(t,d.jsroot_dom,this.webgl),this.first_render_tm=0,this.enable_highlight=!1,!this.isBatchMode()&&this.webgl&&!Ke()&&Re(this),this):this))}function ot(e){let r=!1;this.control&&(this.control.cleanup(),delete this.control,r=!0),Ie(this,e),De(this,!0),r&&Re(this),this.render3D()}function at(e,r,i){if(e){if(!this.toplevel)return console.error("3D objects are not yet created in the frame");r&&i&&this.remove3DMeshes(r),this.toplevel.add(e),e.painter=r}}function rt(e){const r=[];if(!e||!this.toplevel)return r;for(let i=0;i<this.toplevel.children.length;++i){const a=this.toplevel.children[i];a.painter===e&&r.push(a)}return r}function ht(e){this.get3DMeshes(e).forEach(i=>{this.toplevel.remove(i),we(i)})}function lt(e){if(e===-1111){const t=Ve(),o=Ne(!1,0);if(o.setSize(this.scene_width,this.scene_height),o.render(this.scene,this.camera),o.makeOuterHTML){const d=t.createElement("div");return d.innerHTML=o.makeOuterHTML(),d.childNodes[0]}return o.domElement}e===void 0&&(e=5);const r=this.isBatchMode();if(e>0&&!this.usesvg&&!r){this.render_tmout||(this.render_tmout=setTimeout(()=>this.render3D(0),e));return}if(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),!this.renderer)return;$e(this.renderer);const i=new Date;Ae(this.camera,this.toplevel,this.opt3d?.FrontBox,this.opt3d?.BackBox),this.renderer.render(this.scene,this.camera),Ze(this.renderer);const a=new Date;this.first_render_tm===0?(this.first_render_tm=a.getTime()-i.getTime(),this.enable_highlight=this.first_render_tm<1200&&this.isTooltipAllowed(),this.first_render_tm>500&&console.log(`three.js r${m.REVISION}, first render tm = ${this.first_render_tm}`)):st(this),this.processRender3D&&this.forEachPainter(t=>{le(t.handleRender3D)&&t.handleRender3D()},"objects")}function dt(){return this.renderer}function ct(){const e=this.getSizeFor3d(this.access3dKind());if(this.apply3dSize(e),this.scene_width===e.width&&this.scene_height===e.height||e.width<10||e.height<10)return!1;this.scene_width=e.width,this.scene_height=e.height,this.camera.aspect=this.scene_width/this.scene_height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.scene_width,this.scene_height);const r=e.height>10&&e.width>10?Math.round(e.width/e.height*this.size_z3d):this.size_z3d,i=r*this.x3dscale,a=r*this.y3dscale;return Math.abs(i-this.size_x3d)>.15*this.size_z3d||Math.abs(a-this.size_y3d)>.15*this.size_z3d?(this.size_x3d=i,this.size_y3d=a,this.control?.position0?.copy(pe(this,!0)),1):!0}function mt(e,r){const i=!e||e.x1===void 0||!this.enable_highlight;let a=!1,t=null,o=!0,d=this.getMainPainter();if((!d?.provideUserTooltip||!d?.hasUserTooltip())&&(d=null),this.tooltip_selfmesh&&(o=this.tooltip_selfmesh!==r,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,a=!0),this.tooltip_mesh&&(t=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,a=!0),i){a&&(this.render3D(),d?.provideUserTooltip(null));return}if(e.use_itself)r.save_color=r.material.color,r.material.color=new m.Color(e.color),this.tooltip_selfmesh=r,a=o;else{a=!0;const x=ge.Indexes,n=ge.Normals,h=ge.Vertices,_=new m.Color(e.color?e.color:16711680),B=e.opacity||1;let z,p;if(t)z=t.geometry.attributes.position.array,t.geometry.attributes.position.needsUpdate=!0,t.material.color=_,t.material.opacity=B;else{z=new Float32Array(x.length*3),p=new Float32Array(x.length*3);const C=new m.BufferGeometry;C.setAttribute("position",new m.BufferAttribute(z,3)),C.setAttribute("normal",new m.BufferAttribute(p,3));const D=new m.MeshBasicMaterial({color:_,opacity:B,vertexColors:!1});t=new m.Mesh(C,D)}e.x1===e.x2&&console.warn(`same tip X ${e.x1} ${e.x2}`),e.y1===e.y2&&console.warn(`same tip Y ${e.y1} ${e.y2}`),e.z1===e.z2&&(e.z2=e.z1+1e-4);for(let C=0,D=-3;C<x.length;++C){const T=h[x[C]];z[C*3]=e.x1+T.x*(e.x2-e.x1),z[C*3+1]=e.y1+T.y*(e.y2-e.y1),z[C*3+2]=e.z1+T.z*(e.z2-e.z1),p&&(C%6===0&&(D+=3),p[C*3]=n[D],p[C*3+1]=n[D+1],p[C*3+2]=n[D+2])}this.tooltip_mesh=t,this.toplevel.add(t),e.$painter&&e.$painter.options.System!==Le&&(Be(e.$painter,z),t.geometry.computeVertexNormals())}a&&this.render3D(),a&&e.$projection&&le(e.$painter?.redrawProjection)&&e.$painter.redrawProjection(e.ix-1,e.ix,e.iy-1,e.iy),a&&d?.getObject()&&d.provideUserTooltip({obj:d.getObject(),name:d.getObject().fName,bin:e.bin,cont:e.value,binx:e.ix,biny:e.iy,binz:e.iz,grx:(e.x1+e.x2)/2,gry:(e.y1+e.y2)/2,grz:(e.z1+e.z2)/2})}function xt(e){this.opt3d=e}function ft(e,r,i){i||(i={ndim:2}),i.drawany===!1?i.draw=!1:i.drawany=!0;const a=i.v7?null:this.getPadPainter()?.getRootPad(!0);let t=-this.size_x3d,o=this.size_x3d,d=-this.size_y3d,x=this.size_y3d,n=0,h=2*this.size_z3d,_=this.size_z3d,B=this.xmin,z=this.xmax,p=this.ymin,C=this.ymax,D=this.zmin,T=this.zmax,A=!1,$=!1;this.size_z3d||(t=this.xmin,o=this.xmax,d=this.ymin,x=this.ymax,n=this.zmin,h=this.zmax,_=h-n),"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(B=this.zoom_xmin,z=this.zoom_xmax),"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(p=this.zoom_ymin,C=this.zoom_ymax,A=!0),"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(D=this.zoom_zmin,T=this.zoom_zmax,$=!0),i.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,D=p,T=C,$=A,p=0,C=1),this.lego_zmin=D,this.lego_zmax=T,i.zmult!==void 0&&!$&&(T*=i.zmult),this.x_handle=new r(null,this.xaxis),i.v7?(this.x_handle.setPadPainter(this.getPadPainter()),this.x_handle.assignSnapId(this.getSnapId())):i.hist_painter&&this.x_handle.setHistPainter(i.hist_painter,"x"),this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,B,z,!1,[t,o],{log:a?.fLogx??0,reverse:i.reverse_x,logcheckmin:!0}),this.x_handle.assignFrameMembers(this,"x"),this.x_handle.extractDrawAttributes(_),this.y_handle=new r(null,this.yaxis),i.v7?(this.y_handle.setPadPainter(this.getPadPainter()),this.y_handle.assignSnapId(this.getSnapId())):i.hist_painter&&this.y_handle.setHistPainter(i.hist_painter,"y"),this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,p,C,!1,[d,x],{log:a&&!i.use_y_for_z?a.fLogy:0,reverse:i.reverse_y,logcheckmin:i.ndim>1}),this.y_handle.assignFrameMembers(this,"y"),this.y_handle.extractDrawAttributes(_),this.z_handle=new r(null,this.zaxis),i.v7?(this.z_handle.setPadPainter(this.getPadPainter()),this.z_handle.assignSnapId(this.getSnapId())):i.hist_painter&&this.z_handle.setHistPainter(i.hist_painter,"z"),this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,D,T,!1,[n,h],{value_axis:i.ndim===1||i.ndim===2,log:(i.use_y_for_z||i.ndim===2?a?.fLogv:void 0)??a?.fLogz??0,reverse:i.reverse_z,logcheckmin:i.ndim>2}),this.z_handle.assignFrameMembers(this,"z"),this.z_handle.extractDrawAttributes(_),this.setRootPadRange(a,!0);const E={},v={},w=this.x_handle.createTicks(!1,!0),g=this.y_handle.createTicks(!1,!0),L=this.z_handle.createTicks(!1,!0);let y=1;function I(s,l){const c=(l==="ticks"?s.ticksColor:s.lineatt.color)||"black",M=l==="ticks"?s.ticksWidth:s.lineatt.width,f=`${c}_${M}`;return v[f]||(v[f]=new m.LineBasicMaterial(ae(c,{linewidth:M,vertexColors:!1}))),v[f]}function F(s,l,c){const M=c||(l==="title"?s.titleFont?.color:s.labelsFont?.color)||"black";return E[M]||(E[M]=new m.MeshBasicMaterial(ae(M,{vertexColors:!1}))),E[M]}const S=new m.Object3D;S.axis_draw=!0,e.add(S);let H=[],P=[],Z=0,V=0;const ne=this.x_handle.isCenteredLabels(),q=this.x_handle.isRotateLabels();for(;w.next();){const s=w.grpos;let l=w.kind===1,c=this.x_handle.format(w.tick,2);if(w.last_major()?this.x_handle.fTitle||(c="x"):c===null&&(l=!1,c=""),l&&c&&i.draw&&(!ne||!w.last_major())){const M=w.get_modifier();M?.fLabText&&(c=M.fLabText);const f=ze(this,c,this.x_handle.labelsFont.size);f.computeBoundingBox();const b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.center=!0,f.offsety=this.x_handle.labelsOffset+(x-d)*.005,V=Math.max(V,b),Z=Math.max(Z,k),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.grx=s,P.push(f);let u=0;w.last_major()||(u=Math.abs(w.next_major_grpos()-s),b>0&&u>0&&(y=Math.min(y,.9*u/b))),q&&(f.rotate=1),ne&&(u||(u=Math.min(s-t,o-s)),f.grx+=u/2)}H.push(s,0,0,s,this.x_handle.ticksSize*(l?-1:-.6),0)}if(this.x_handle.fTitle&&i.draw){const s=ze(this,this.x_handle.fTitle,this.x_handle.titleFont.size);s.computeBoundingBox(),s.center=this.x_handle.titleCenter,s.opposite=this.x_handle.titleOpposite,s.offsety=1.6*this.x_handle.titleOffset+(x-d)*.005,s.grx=(t+o)/2,s.kind="title",this.x_handle.isRotateTitle()&&(s.rotate=2),P.push(s)}this.get3dZoomCoord=function(s,l){const c=this[`scale_${l}min`],M=this[`scale_${l}max`];let f=s[l];switch(l){case"x":f=(f+this.size_x3d)/2/this.size_x3d;break;case"y":f=(f+this.size_y3d)/2/this.size_y3d;break;case"z":f=f/2/this.size_z3d;break}return this["log"+l]?f=Math.exp(Math.log(c)+f*(Math.log(M)-Math.log(c))):f=c+f*(M-c),f};const W=(s,l,c)=>{const M=new m.BufferGeometry,f=Math.max(this[s+"_handle"].ticksSize,.005*l);let b;s==="z"?b=new Float32Array([0,0,0,f*4,0,2*l,f*4,0,0,0,0,0,0,0,2*l,f*4,0,2*l]):b=new Float32Array([-l,0,0,l,-f*4,0,l,0,0,-l,0,0,-l,-f*4,0,l,-f*4,0]),M.setAttribute("position",new m.BufferAttribute(b,3)),M.computeVertexNormals();const k=new m.MeshBasicMaterial({transparent:!0,vertexColors:!1,side:m.DoubleSide,opacity:0}),u=new m.Mesh(M,k);return u.zoom=s,u.size_3d=l,u.tsz=f,u.use_y_for_z=c,s==="y"&&u.rotateZ(Math.PI/2).rotateX(Math.PI),u.v1=new m.Vector3(b[0],b[1],b[2]),u.v2=new m.Vector3(b[6],b[7],b[8]),u.v3=new m.Vector3(b[3],b[4],b[5]),u.globalIntersect=function(J){if(!this.v1||!this.v2||!this.v3)return;const O=new m.Plane;O.setFromCoplanarPoints(this.v1,this.v2,this.v3),O.applyMatrix4(this.matrixWorld);const U=J.ray.origin.clone(),oe=U.clone().addScaledVector(J.ray.direction,1e10),j=O.intersectLine(new m.Line3(U,oe),new m.Vector3);if(!j)return;let X=-this.size_3d,me=this.size_3d;return this.zoom==="z"&&(X=0,me=2*this.size_3d),j[this.zoom]<X?j[this.zoom]=X:j[this.zoom]>me&&(j[this.zoom]=me),j},u.showSelection=function(J,O){let U=this.children?this.children[0]:null,oe;if(!J||!O)return U&&(this.remove(U),we(U)),U;if(!this.geometry)return!1;if(U)oe=U.geometry;else{oe=this.geometry.clone();const X=oe.getAttribute("position").array;this.zoom==="z"?X[6]=X[3]=X[15]=this.tsz:X[4]=X[16]=X[13]=-this.tsz,U=new m.Mesh(oe,new m.MeshBasicMaterial({color:65280,side:m.DoubleSide,vertexColors:!1})),this.add(U)}const j=oe.getAttribute("position").array;return this.zoom==="z"?(j[2]=j[11]=j[8]=J[this.zoom],j[5]=j[17]=j[14]=O[this.zoom]):(j[0]=j[9]=j[12]=J[this.zoom],j[6]=j[3]=j[15]=O[this.zoom]),oe.getAttribute("position").needsUpdate=!0,!0},u};let N=new m.Object3D,de;N.position.set(0,d,n),N.rotation.x=1/4*Math.PI,N.xyid=2,N.painter=this.x_handle,i.draw&&(de=ie(H,I(this.x_handle,"ticks")),N.add(de)),P.forEach(s=>{const l=s.boundingBox.max.x-s.boundingBox.min.x,c=s.boundingBox.max.y-s.boundingBox.min.y,M=s.rotate===1?c:l,f=s.center?s.grx-M/2:s.opposite?t:o-M,b=-y*(s.rotate===1?V:Z)-this.x_handle.ticksSize-s.offsety,k=new m.Matrix4;k.set(y,0,0,f,0,y,0,b,0,0,1,0,0,0,0,1);const u=new m.Mesh(s,F(this.x_handle,s.kind,s.color));s.rotate&&u.rotateZ(s.rotate*Math.PI/2),s.rotate===1&&u.translateY(-c),s.rotate===2&&u.translateX(-l),u.applyMatrix4(k),N.add(u)}),i.zoom&&i.drawany&&N.add(W("x",this.size_x3d)),S.add(N),N=new m.Object3D,N.position.set(0,x,n),N.rotation.x=3/4*Math.PI,N.painter=this.x_handle,i.draw&&N.add(new m.LineSegments(de.geometry,de.material)),P.forEach(s=>{const l=s.boundingBox.max.x-s.boundingBox.min.x,c=s.boundingBox.max.y-s.boundingBox.min.y,M=s.rotate===1?c:l,f=s.center?s.grx+M/2:s.opposite?t+M:o,b=-y*(s.rotate===1?V:Z)-this.x_handle.ticksSize-s.offsety,k=new m.Matrix4;k.set(-y,0,0,f,0,y,0,b,0,0,-1,0,0,0,0,1);const u=new m.Mesh(s,F(this.x_handle,s.kind,s.color));s.rotate&&u.rotateZ(s.rotate*Math.PI/2),s.rotate===1&&u.translateY(-c),s.rotate===2&&u.translateX(-l),u.applyMatrix4(k),N.add(u)}),N.xyid=4,i.zoom&&i.drawany&&N.add(W("x",this.size_x3d)),S.add(N),P=[],y=1,V=Z=0,H=[];const xe=this.y_handle.isCenteredLabels(),re=this.y_handle.isRotateLabels();for(;g.next();){const s=g.grpos;let l=g.kind===1,c=this.y_handle.format(g.tick,2);if(g.last_major()?this.y_handle.fTitle||(c="y"):c===null&&(l=!1,c=""),l&&c&&i.draw&&(!xe||!g.last_major())){const M=g.get_modifier();M?.fLabText&&(c=M.fLabText);const f=ze(this,c,this.y_handle.labelsFont.size);f.computeBoundingBox();const b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.center=!0,V=Math.max(V,b),Z=Math.max(Z,k),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.gry=s,f.offsetx=this.y_handle.labelsOffset+(o-t)*.005,P.push(f);let u=0;g.last_major()||(u=Math.abs(g.next_major_grpos()-s),b>0&&(y=Math.min(y,.9*u/b))),xe&&(u||(u=Math.min(s-d,x-s)),f.gry+=u/2),re&&(f.rotate=1)}H.push(0,s,0,this.y_handle.ticksSize*(l?-1:-.6),s,0)}if(this.y_handle.fTitle&&i.draw){const s=ze(this,this.y_handle.fTitle,this.y_handle.titleFont.size);s.computeBoundingBox(),s.center=this.y_handle.titleCenter,s.opposite=this.y_handle.titleOpposite,s.offsetx=1.6*this.y_handle.titleOffset+(o-t)*.005,s.gry=(d+x)/2,s.kind="title",this.y_handle.isRotateTitle()&&(s.rotate=2),P.push(s)}if(!i.use_y_for_z){let s,l=new m.Object3D;l.position.set(t,0,n),l.rotation.y=-1/4*Math.PI,l.painter=this.y_handle,i.draw&&(s=ie(H,I(this.y_handle,"ticks")),l.add(s)),P.forEach(c=>{const M=c.boundingBox.max.x-c.boundingBox.min.x,f=c.boundingBox.max.y-c.boundingBox.min.y,b=c.rotate===1?f:M,k=-y*(c.rotate===1?V:Z)-this.y_handle.ticksSize-c.offsetx,u=c.center?c.gry+b/2:c.opposite?d+b:x,J=new m.Matrix4;J.set(0,y,0,k,-y,0,0,u,0,0,1,0,0,0,0,1);const O=new m.Mesh(c,F(this.y_handle,c.kind,c.color));c.rotate&&O.rotateZ(c.rotate*Math.PI/2),c.rotate===1&&O.translateY(-f),c.rotate===2&&O.translateX(-M),O.applyMatrix4(J),l.add(O)}),l.xyid=3,i.zoom&&i.drawany&&l.add(W("y",this.size_y3d)),S.add(l),l=new m.Object3D,l.position.set(o,0,n),l.rotation.y=-3/4*Math.PI,l.painter=this.y_handle,i.draw&&l.add(new m.LineSegments(s.geometry,s.material)),P.forEach(c=>{const M=c.boundingBox.max.x-c.boundingBox.min.x,f=c.boundingBox.max.y-c.boundingBox.min.y,b=c.rotate===1?f:M,k=-y*(c.rotate===1?V:Z)-this.y_handle.ticksSize-c.offsetx,u=c.center?c.gry-b/2:c.opposite?d:x-b,J=new m.Matrix4;J.set(0,y,0,k,y,0,0,u,0,0,-1,0,0,0,0,1);const O=new m.Mesh(c,F(this.y_handle,c.kind,c.color));c.rotate&&O.rotateZ(c.rotate*Math.PI/2),c.rotate===1&&O.translateY(-f),c.rotate===2&&O.translateX(-M),O.applyMatrix4(J),l.add(O)}),l.xyid=1,i.zoom&&i.drawany&&l.add(W("y",this.size_y3d)),S.add(l)}P=[],y=1,H=[];let ce=null,fe=null,ye=null,Q=0;const Me=this.z_handle.isCenteredLabels(),Pe=this.z_handle.isRotateLabels();for(this.size_z3d&&i.drawany&&(ce=[],fe=[]);L.next();){const s=L.grpos;let l=L.kind===1,c=this.z_handle.format(L.tick,2);if(c===null&&(l=!1,c=""),l&&c&&i.draw&&(!Me||!L.last_major())){const M=L.get_modifier();M?.fLabText&&(c=M.fLabText);const f=ze(this,c,this.z_handle.labelsFont.size);f.computeBoundingBox();const b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.translate(-b,-k/2,0),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.grz=s,P.push(f),ye!==null&&k>0&&(y=Math.min(y,.9*(s-ye)/k)),Q=Math.max(Q,b),ye=s}ce&&l&&ce.push(t,0,s,o,0,s),fe&&l&&fe.push(0,d,s,0,x,s),H.push(0,0,s,this.z_handle.ticksSize*(l?1:.6),0,s)}if(ce?.length){const s=new m.LineDashedMaterial({color:this.x_handle.ticksColor,dashSize:2,gapSize:2}),l=ie(ce,s);l.position.set(0,x,0),l.grid=2,l.visible=!1,S.add(l);const c=new m.LineSegments(l.geometry,s);c.position.set(0,d,0),c.grid=4,c.visible=!1,S.add(c)}if(fe?.length){const s=new m.LineDashedMaterial({color:this.y_handle.ticksColor,dashSize:2,gapSize:2}),l=ie(fe,s);l.position.set(o,0,0),l.grid=3,l.visible=!1,S.add(l);const c=new m.LineSegments(l.geometry,s);c.position.set(t,0,0),c.grid=1,c.visible=!1,S.add(c)}const G=[],_e=i.draw?ie(H,I(this.z_handle,"ticks")):null;for(let s=0;s<4;++s){if(G.push(new m.Object3D),P.forEach((l,c)=>{const M=new m.Matrix4,f=l.boundingBox.max.x-l.boundingBox.min.x;let b=l.grz;Me&&(c<P.length-1?b=(b+P[c+1].grz)/2:c>0&&(b=Math.min(1.5*b-P[c-1].grz*.5,h))),M.set(-y,0,0,this.z_handle.ticksSize+(o-t)*.005+this.z_handle.labelsOffset,0,0,1,0,0,y,0,b);const k=new m.Mesh(l,F(this.z_handle));Pe&&k.rotateZ(-Math.PI/2).translateX(f/2),k.applyMatrix4(M),G[s].add(k)}),this.z_handle.fTitle&&i.draw){const l=ze(this,this.z_handle.fTitle,this.z_handle.titleFont.size);l.computeBoundingBox();const c=l.boundingBox.max.x-l.boundingBox.min.x,M=l.boundingBox.max.y-l.boundingBox.min.y,f=this.z_handle.isRotateTitle(),b=this.z_handle.titleCenter?(h+n-c)/2:(this.z_handle.titleOpposite?n:h-c)+(f?c:0),k=new m.Matrix4;k.set(-y,0,0,this.z_handle.ticksSize+(o-t)*.005+Q+this.z_handle.titleOffset,0,0,1,0,0,y,0,b);const u=new m.Mesh(l,F(this.z_handle,"title"));u.rotateZ(Math.PI*(f?1.5:.5)),f&&u.translateY(-M),u.applyMatrix4(k),G[s].add(u)}i.draw&&_e&&G[s].add(s===0?_e:new m.LineSegments(_e.geometry,_e.material)),i.zoom&&i.drawany&&G[s].add(W("z",this.size_z3d,i.use_y_for_z)),G[s].zid=s+2,S.add(G[s]),G[s].painter=this.z_handle}if(G[0].position.set(t,x,0),G[0].rotation.z=3/4*Math.PI,G[1].position.set(o,x,0),G[1].rotation.z=1/4*Math.PI,G[2].position.set(o,d,0),G[2].rotation.z=-1/4*Math.PI,G[3].position.set(t,d,0),G[3].rotation.z=-3/4*Math.PI,!i.drawany)return;const R=I(this.x_handle),se=ie([t,0,0,o,0,0],R,null,!0);for(let s=0;s<2;++s){let l=new m.LineSegments(se,R);l.position.set(0,d,s===0?n:h),l.xyboxid=2,l.bottom=s===0,S.add(l),l=new m.LineSegments(se,R),l.position.set(0,x,s===0?n:h),l.xyboxid=4,l.bottom=s===0,S.add(l)}const ee=I(this.y_handle),K=ie([0,d,0,0,x,0],ee,null,!0);for(let s=0;s<2;++s){let l=new m.LineSegments(K,ee);l.position.set(t,0,s===0?n:h),l.xyboxid=3,l.bottom=s===0,S.add(l),l=new m.LineSegments(K,ee),l.position.set(o,0,s===0?n:h),l.xyboxid=1,l.bottom=s===0,S.add(l)}const Y=I(this.z_handle),he=ie([0,0,n,0,0,h],Y,null,!0);for(let s=0;s<4;++s){const l=new m.LineSegments(he,Y);l.zboxid=G[s].zid,l.position.copy(G[s].position),S.add(l)}}function gt(e,r,i){e=this.x_handle.gr(e),r=this.y_handle.gr(r),i=this.z_handle.gr(i);const a=new m.Vector3().set(e,r,i);a.project(this.camera),a.x=(a.x+1)/2,a.y=(a.y+1)/2;const t=this.getPadPainter(),o=t?.getPadWidth(),d=t?.getPadHeight();return o&&d&&(a.x=(this.scene_x+a.x*this.scene_width)/o,a.y=(this.scene_y+a.y*this.scene_height)/d),a}function _t(e){Object.assign(e,{create3DScene:nt,add3DMesh:at,get3DMeshes:rt,remove3DMeshes:ht,getRenderer:dt,render3D:lt,resize3D:ct,change3DCamera:ot,highlightBin3D:mt,set3DOptions:xt,drawXYZ:ft,convert3DtoPadNDC:gt})}async function vt(e,r,i=ve.Render3D.None){const a=e.getFramePainter(),t=e.getOptions(),o=e.getHisto(),d=e.getDimension();return _t(a),a.create3DScene(i,t.x3dscale,t.y3dscale,t.Ortho).then(()=>(a.setAxesRanges(o.fXaxis,e.xmin,e.xmax,o.fYaxis,e.ymin,e.ymax,o.fZaxis,e.zmin,e.zmax,e),a.set3DOptions(t),a.drawXYZ(a.toplevel,r,{ndim:d,use_y_for_z:d===1,hist_painter:e,zmult:t.zmult??1,zoom:i!==ve.Render3D.None&&Oe.Zooming,draw:t.Axis!==-1,drawany:t.isCartesian(),reverse_x:t.RevX,reverse_y:t.RevY}),a))}function Fe(e){if(e.faceIndex<0||e.faceIndex>=this.face_to_bins_index.length)return null;const r=this.tip_painter;if(!r)return console.error("painter for tip handling is not there"),null;const i=this.handle,a=r.getFramePainter(),t=r.getHisto(),o=r.get3DToolTip(this.face_to_bins_index[e.faceIndex]),d=Math.min(a.size_x3d,Math.max(-a.size_x3d,i.grx[o.ix-1]+i.xbar1*(i.grx[o.ix]-i.grx[o.ix-1]))),x=Math.min(a.size_x3d,Math.max(-a.size_x3d,i.grx[o.ix-1]+i.xbar2*(i.grx[o.ix]-i.grx[o.ix-1]))),n=Math.min(a.size_y3d,Math.max(-a.size_y3d,i.gry[o.iy-1]+i.ybar1*(i.gry[o.iy]-i.gry[o.iy-1]))),h=Math.min(a.size_y3d,Math.max(-a.size_y3d,i.gry[o.iy-1]+i.ybar2*(i.gry[o.iy]-i.gry[o.iy-1])));o.x1=Math.min(d,x),o.x2=Math.max(d,x),o.y1=Math.min(n,h),o.y2=Math.max(n,h);let _=this.baseline,B=o.value;return t.$baseh&&(_=t.$baseh.getBinContent(o.ix,o.iy)),B<_&&([_,B]=[B,_]),o.z1=a.grz(Math.max(this.zmin,_)),o.z2=a.grz(Math.min(this.zmax,B)),o.color=this.tip_color,o.$painter=r,o.$projection=r.getDimension()===2&&le(r.isProjection)&&r.isProjection(),o}function Ct(e,r=!1){if(!e.draw_content)return;const i=ge.Vertices,a=ge.Indexes,t=ge.Normals,o=ge.Segments,d=[0,1,1,2,2,3,3,0],x=[new m.Vector3(0,0,0),new m.Vector3(0,1,0),new m.Vector3(1,1,0),new m.Vector3(1,0,0)],n=e.getFramePainter(),h=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),_=e.options.cutg,B=h.i1,z=h.i2,p=h.j1,C=h.j2,D=e.getHisto(),T=D.$baseh,A=e.options.Lego===11||e.options.Lego===13,$=D.getBin(z,C)<65535;if(B>=z||p>=C)return;let E,v,w,g,L,y,I,F,S,H,P,Z=n.z_handle.getScaleMin(),V=n.z_handle.getScaleMax();const ne=(R,se,ee)=>(F=D.getBinContent(R+1,se+1),T?I=T.getBinContent(R+1,se+1):e.options.BaseLine!==!1?I=e.options.BaseLine:I=e.options.Zero?Z:0,F<I&&([I,F]=[F,I]),I>=v||F<E||_&&!_.IsInside(D.fXaxis.GetBinCoord(R+.5),D.fYaxis.GetBinCoord(se+.5))?!1:(S=F===E||I>=F,!S||ee>0?!0:T?!1:e.options.Zero||Z>0?!0:e.options.ShowEmpty));let q=[Z,V],W=null;(e.options.Lego===12||e.options.Lego===14)&&(r?(W=n.getHistPalette(),e.createContour(n,W,{full_z_range:!0}),q=W.getContour(),Z=q.at(0),V=q.at(-1)):(q=e.createContour(D.fContour?D.fContour.length:20,n.lego_zmin,n.lego_zmax).arr,W=e.getHistPalette()));for(let R=0;R<q.length-1;++R){E=q[R],v=q[R+1],W&&R===q.length-2&&v<V&&(v=V);const se=n.grz(E),ee=n.grz(v);let K=0,Y=0;for(w=B;w<z;++w)for(g=p;g<C;++g)ne(w,g,R)&&(H=!S&&R>0,P=!S&&F>v&&R<q.length-2,K+=S?12:a.length,H&&(K-=6),P&&(K-=6),A&&!S&&(K-=12,Y+=12));const he=new Float32Array(K*3),s=new Float32Array(K*3),l=$?new Uint16Array(K/3):new Uint32Array(K/3),c=Y===0?null:new Float32Array(Y*3),M=Y===0?null:new Float32Array(Y*3),f=Y===0?null:$?new Uint16Array(Y/3):new Uint32Array(Y/3);let b=0,k=0,u;for(w=B;w<z;++w){const X=h.grx[w]+h.xbar1*(h.grx[w+1]-h.grx[w]),me=h.grx[w]+h.xbar2*(h.grx[w+1]-h.grx[w]);for(g=p;g<C;++g){if(!ne(w,g,R))continue;H=!S&&R>0,P=!S&&F>v&&R<q.length-2;const ue=h.gry[g]+h.ybar1*(h.gry[g+1]-h.gry[g]),te=h.gry[g]+h.ybar2*(h.gry[g+1]-h.gry[g]),be=I<=E?se:n.grz(I),Se=F>v?ee:n.grz(F);u=0,L=0,S&&(u+=12,L+=24);const ke=D.getBin(w+1,g+1);let Te=a.length;for(H&&(Te-=6);L<Te;)y=i[a[L]],A&&L<12?(c[k]=X+y.x*(me-X),c[k+1]=ue+y.y*(te-ue),c[k+2]=be+y.z*(Se-be),M[k]=t[u],M[k+1]=t[u+1],M[k+2]=t[u+2],k%9===0&&(f[k/9]=ke),k+=3):(he[b]=X+y.x*(me-X),he[b+1]=ue+y.y*(te-ue),he[b+2]=be+y.z*(Se-be),s[b]=t[u],s[b+1]=t[u+1],s[b+2]=t[u+2],b%9===0&&(l[b/9]=ke),b+=3),++L,L%6===0&&(u+=3,P&&L===a.length-12&&(L+=6,u+=3))}}const J=Ce(e,he,s);let O=r?3:D.fFillColor,U=e.getColor(O);W?U=r?W.getColor(R):W.calcColor(R,q.length):(e.options.Lego===1||O<2)&&(O=1,U="white");const oe=new m.MeshBasicMaterial(ae(U,{vertexColors:!1})),j=new m.Mesh(J,oe);if(j.face_to_bins_index=l,j.tip_painter=e,j.zmin=Z,j.zmax=V,j.baseline=e.options.BaseLine!==!1?e.options.BaseLine:e.options.Zero?Z:0,j.tip_color=O===3?16711680:65280,j.handle=h,j.tooltip=Fe,n.add3DMesh(j),Y>0){const X=Ce(e,c,M),me=new m.Color(O<2?16711680:Ee(U).darker(.5).toString()),ue=new m.MeshBasicMaterial({color:me,vertexColors:!1}),te=new m.Mesh(X,ue);te.face_to_bins_index=f,te.tip_painter=e,te.handle=j.handle,te.tooltip=Fe,te.zmin=j.zmin,te.zmax=j.zmax,te.baseline=j.baseline,te.tip_color=j.tip_color,n.add3DMesh(te)}}if(e.options.Lego>12)return;let N=0,de=0;for(v=V,E=Z,w=B;w<z;++w)for(g=p;g<C;++g)ne(w,g,0)&&(N+=S?x.length:i.length,de+=S?d.length:o.length);const xe=N<=65520;xe||(N=de*3);const re=new Float32Array(N*3),ce=xe?new Uint16Array(de):null,fe=n.grz(Z),ye=n.grz(V);let Q=0,Me=0;for(w=B;w<z;++w){const R=h.grx[w]+h.xbar1*(h.grx[w+1]-h.grx[w]),se=h.grx[w]+h.xbar2*(h.grx[w+1]-h.grx[w]);for(g=p;g<C;++g){if(!ne(w,g,0))continue;const ee=h.gry[g]+h.ybar1*(h.gry[g+1]-h.gry[g]),K=h.gry[g]+h.ybar2*(h.gry[g+1]-h.gry[g]),Y=I<=Z?fe:n.grz(I),he=F>V?ye:n.grz(F),s=S?d:o,l=S?x:i;if(xe){for(L=0;L<s.length;++L)ce[Me++]=Q/3+s[L];for(L=0;L<l.length;++L)y=l[L],re[Q]=R+y.x*(se-R),re[Q+1]=ee+y.y*(K-ee),re[Q+2]=Y+y.z*(he-Y),Q+=3}else for(L=0;L<s.length;++L)y=l[s[L]],re[Q]=R+y.x*(se-R),re[Q+1]=ee+y.y*(K-ee),re[Q+2]=Y+y.z*(he-Y),Q+=3}}const Pe=r?e.v7EvalColor("line_color","lightblue"):e.getColor(D.fLineColor),G=new m.LineBasicMaterial(ae(Pe,{linewidth:r?e.v7EvalAttr("line_width",1):D.fLineWidth})),_e=ie(Be(e,re),G,xe?ce:null);n.add3DMesh(_e)}function ut(e){const r=Math.floor(e.index/6);if(r<0||r>=this.intersect_index.length)return null;const i=this.painter,a=i.getHisto(),t=i.getFramePainter(),o=i.get3DToolTip(this.intersect_index[r]),d=Math.min(t.size_x3d,Math.max(-t.size_x3d,t.grx(a.fXaxis.GetBinLowEdge(o.ix)))),x=Math.min(t.size_x3d,Math.max(-t.size_x3d,t.grx(a.fXaxis.GetBinLowEdge(o.ix+1)))),n=Math.min(t.size_y3d,Math.max(-t.size_y3d,t.gry(a.fYaxis.GetBinLowEdge(o.iy)))),h=Math.min(t.size_y3d,Math.max(-t.size_y3d,t.gry(a.fYaxis.GetBinLowEdge(o.iy+1))));return o.x1=Math.min(d,x),o.x2=Math.max(d,x),o.y1=Math.min(n,h),o.y2=Math.max(n,h),o.z1=t.grz(o.value-o.error<this.zmin?this.zmin:o.value-o.error),o.z2=t.grz(o.value+o.error>this.zmax?this.zmax:o.value+o.error),o.color=this.tip_color,o}function Bt(e,r=!1){const i=e.getFramePainter(),a=e.getHisto(),t=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),o=i.z_handle.getScaleMin(),d=i.z_handle.getScaleMax(),x=e.options.cutg;let n,h,_,B,z,p,C,D,T,A,$,E=0,v=null,w=null,g=0;const L=()=>e.options.Zero||o>0?!1:!e.options.ShowEmpty;for(let S=0;S<2;++S){for(n=t.i1;n<t.i2;++n)for(p=t.grx[n],D=t.grx[n+1],h=t.j1;h<t.j2;++h)if(B=a.getBinContent(n+1,h+1),!(B<o||B>d)&&!(B===o&&L())&&!(x&&!x.IsInside(a.fXaxis.GetBinCoord(n+.5),a.fYaxis.GetBinCoord(h+.5)))){if(S===0){E+=3;continue}_=a.getBin(n+1,h+1),z=e.getBinErrors(a,_,B),w[g/18]=_,C=t.gry[h],T=t.gry[h+1],A=i.grz(B-z.low<o?o:B-z.low),$=i.grz(B+z.up>d?d:B+z.up),v[g]=p,v[g+3]=D,v[g+1]=v[g+4]=(C+T)/2,v[g+2]=v[g+5]=(A+$)/2,g+=6,v[g]=v[g+3]=(p+D)/2,v[g+1]=C,v[g+4]=T,v[g+2]=v[g+5]=(A+$)/2,g+=6,v[g]=v[g+3]=(p+D)/2,v[g+1]=v[g+4]=(C+T)/2,v[g+2]=A,v[g+5]=$,g+=6}if(S===0){if(E===0)return;v=new Float32Array(E*6),w=new Int32Array(E/3)}}const y=r?e.v7EvalColor("line_color","lightblue"):e.getColor(a.fLineColor),I=new m.LineBasicMaterial(ae(y,{linewidth:r?e.v7EvalAttr("line_width",1):a.fLineWidth})),F=ie(v,I);F.painter=e,F.intersect_index=w,F.zmin=o,F.zmax=d,F.tip_color=a.fLineColor===3?16711680:65280,F.tooltip=ut,i.add3DMesh(F)}function zt(e,r=!1,i=!1){const a=e.getFramePainter(),t=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0}),o=e.getHisto(),d=e.getContourLevels(),x=e.getHistPalette(),n=[];let h=2*a.size_z3d;je(o,t,d,x,(B,z,p,C,D,T)=>{if(!(D-C<3)&&!(r&&(h=a.grz(d[T]),h<0||h>2*a.size_z3d)))for(let A=C;A<D;++A)n.push(z[A],p[A],h),n.push(z[A+1],p[A+1],h)});const _=ie(n,He(e,i?"line_":o));a.add3DMesh(_)}function Pt(e,r=!1){const i=e.getHisto(),a=e.getFramePainter(),t=a.z_handle.getScaleMin(),o=a.logz?z=>z<t?-.1:a.grz(z):a.grz,d=0,x=2*a.size_z3d;let n=e.prepareDraw({rounding:!1,use3d:!0,extra:1,middle:.5,cutg:le(e.options?.cutg?.IsInside)?e.options?.cutg:null});if(n.i2-n.i1<2||n.j2-n.j1<2)return;let h=null,_=null,B=null;if(n.dolines=!0,r){let z=0;switch(e.options.Surf){case 11:z=2;break;case 12:case 15:case 17:z=2,n.dolines=!1;break;case 14:n.dolines=!1,n.donormals=!0;break;case 16:z=1,n.dogrid=!0,n.dolines=!1;break;default:h=a.z_handle.createTicks(!0),n.dogrid=!0;break}z>0&&(B=a.getHistPalette(),z===2&&e.createContour(a,B,{full_z_range:!0}),h=B.getContour())}else switch(e.options.Surf){case 11:h=e.getContourLevels(),B=e.getHistPalette();break;case 12:case 15:case 17:h=e.getContourLevels(),B=e.getHistPalette(),n.dolines=!1;break;case 14:n.dolines=!1,n.donormals=!0;break;case 16:h=e.getContourLevels(),n.dogrid=!0,n.dolines=!1;break;default:h=a.z_handle.createTicks(!0),n.dogrid=!0;break}if(h){_=new Float32Array(h.length);for(let z=0;z<h.length;++z)_[z]=o(h[z])}else _=[d,x];if(n.grz=o,n.grz_min=d,n.grz_max=x,it(i,n,h,(z,p,C)=>{const D=Ce(e,p,null,n.i2-n.i1,n.j2-n.j1),T=D.getAttribute("normal").array;if(n.donormals&&z===1)for(let v=n.i1;v<n.i2;++v)for(let w=n.j1;w<n.j2;++w){const g=((v-n.i1)*(n.j2-n.j1)+(w-n.j1))*8;if(C[g]===-1)continue;const L=C[g]>=0?g:g+9+C[g],y=g+8;let I=0,F=0,S=0;for(let H=L;H<y;++H){const P=C[H];if(P<0)return console.error("FAILURE in NORMALS RECALCULATIONS");I+=T[P],F+=T[P+1],S+=T[P+2]}I/=y-L,F/=y-L,S/=y-L;for(let H=L;H<y;++H){const P=C[H];T[P]=I,T[P+1]=F,T[P+2]=S}}let A,$;if(r)A=B?.getColor(z-1)??e.getColor(5);else if(B)A=B.calcColor(z,_.length);else{const v=e.options.histoFillColor||i.fFillColor;e.options.Surf===13?A="white":e.options.Surf===14?A=v>1?e.getColor(v):"grey":A=v>1?e.getColor(v):"white"}A||(A="white"),e.options.Surf===14?$=new m.MeshLambertMaterial(ae(A,{side:m.DoubleSide,vertexColors:!1})):$=new m.MeshBasicMaterial(ae(A,{side:m.DoubleSide,vertexColors:!1}));const E=new m.Mesh(D,$);a.add3DMesh(E),E.painter=e},(z,p)=>{const C=e.getColor(i.fLineColor)??"white";let D;z?D=e.options.Surf===1?new m.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new m.LineBasicMaterial(ae(C)):D=new m.LineBasicMaterial(ae(C,{linewidth:i.fLineWidth}));const T=ie(Be(e,p,n.i2-n.i1,n.j2-n.j1),D);T.painter=e,a.add3DMesh(T)}),e.options.Surf===17&&zt(e,!1,r),e.options.Surf===13){n=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0});const z=e.getContourLevels(),p=e.getHistPalette();let C=-1,D=x;je(i,n,z,p,(T,A,$,E,v)=>{if(A[v]===A[E]&&$[v]===$[E]&&v--,v-E<3)return;const w=[];for(let P=E;P<=v;++P)(P===E||A[P]!==A[P-1]||$[P]!==$[P-1])&&w.push(new m.Vector2(A[P],$[P]));const g=w.length<3?null:m.ShapeUtils.triangulateShape(w,[]);if(!g?.length)return;(C<0||C!==T)&&(C=T,D+=5e-5*x);const L=new Float32Array(g.length*9),y=new Float32Array(g.length*9);let I=0;for(let P=0;P<g.length;++P){const Z=g[P];for(let V=0;V<3;++V){const ne=w[Z[V]];L[I]=ne.x,L[I+1]=ne.y,L[I+2]=D,y[I]=0,y[I+1]=0,y[I+2]=1,I+=3}}const F=Ce(e,L,y,n.i2-n.i1,n.j2-n.j1),S=new m.MeshBasicMaterial(ae(p.getColor(T),{side:m.DoubleSide,opacity:.5,vertexColors:!1})),H=new m.Mesh(F,S);H.painter=e,a.add3DMesh(H)})}}export{Be as a,vt as b,Ce as c,Ct as d,zt as e,Pt as f,Bt as g};
