import{O as M,D as B,bA as R,aS as p,bB as D,Y as z,bC as N,aI as v,bD as O,K as y,a as A,j as _,aY as w,L as T,e as k,V as Z}from"./index-DAa9yKAB.js";import{TPavePainter as F}from"./TPavePainter-DMWA3hUD.js";class I extends M{#t;decodeOptions(t){const i=new B(t),e=this.getObject();i.check("CONST")&&e&&(e.fConstRatio=!0),this.setOptions({Zscale:i.check("Z")})}createRGBA(t){const i=this.getObject(),e=i?.fPalette;if(!e)return null;const a=new Array((t+1)*4).fill(0);for(let o=0,r=1;o<=t;++o){const f=o/t;for(;e.fPoints[r]<f&&r<e.fPoints.length-1;)r++;const n=(e.fPoints[r]-f)/(e.fPoints[r]-e.fPoints[r-1]),s=(f-e.fPoints[r-1])/(e.fPoints[r]-e.fPoints[r-1]);a[o*4]=Math.min(255,Math.round((e.fColorRed[r-1]*n+e.fColorRed[r]*s)/256)),a[o*4+1]=Math.min(255,Math.round((e.fColorGreen[r-1]*n+e.fColorGreen[r]*s)/256)),a[o*4+2]=Math.min(255,Math.round((e.fColorBlue[r-1]*n+e.fColorBlue[r]*s)/256)),a[o*4+3]=Math.min(255,Math.round((e.fColorAlpha[r-1]*n+e.fColorAlpha[r]*s)/256))}return a}cleanup(){this.#t=void 0,super.cleanup()}getContour(){return this.#t}async makeUrlFromImageBuf(t,i){this.rgba=this.createRGBA(1e3);let a=t.fImgBuf[0],o=t.fImgBuf[0];for(let n=1;n<t.fImgBuf.length;++n){const s=t.fImgBuf[n];a=Math.min(s,a),o=Math.max(s,o)}this.#t={arr:new Array(200),rgba:this.rgba,getLevels(){return this.arr},getPaletteColor(n,s){if(!this.arr||!this.rgba)return"white";const h=Math.round((s-this.arr[0])/(this.arr.at(-1)-this.arr.at(0))*(this.rgba.length-4)/4)*4;return R(this.rgba[h]/255,this.rgba[h+1]/255,this.rgba[h+2]/255,this.rgba[h+3]/255)}};for(let n=0;n<200;n++)this.#t.arr[n]=a+(o-a)/199*n;a>=o&&(o=a+1);const r=this.getImageZoomRange(i,t.fConstRatio,t.fWidth,t.fHeight);return(p()?D(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]).then(n=>n.default.createCanvas(r.xmax-r.xmin,r.ymax-r.ymin)):new Promise(n=>{const s=document.createElement("canvas");s.width=r.xmax-r.xmin,s.height=r.ymax-r.ymin,n(s)})).then(n=>{const s=n.getContext("2d"),h=s.getImageData(0,0,n.width,n.height),m=h.data;for(let l=r.ymin;l<r.ymax;++l){let g=(r.ymax-l-1)*(r.xmax-r.xmin)*4;const d=l*t.fWidth;for(let u=r.xmin;u<r.xmax;++u){let c=Math.round((t.fImgBuf[d+u]-a)/(o-a)*1e3)*4;m[g++]=this.rgba[c++],m[g++]=this.rgba[c++],m[g++]=this.rgba[c++],m[g++]=this.rgba[c]}}return s.putImageData(h,0,0),{url:n.toDataURL(),constRatio:t.fConstRatio,can_zoom:!0}})}getImageZoomRange(t,i,e,a){const o={xmin:0,xmax:e,ymin:0,ymax:a};if(!t)return o;let r=0,f=0,n=e,s=a;if(i){const h=a/e,m=t.getFrameHeight()/t.getFrameWidth();if(h>m){const l=a/m;r=Math.round((l-e)/2),n=Math.round(l)}else{const l=m*e;f=Math.round((l-a)/2),s=Math.round(l)}}return t.zoom_xmin!==t.zoom_xmax&&(o.xmin=Math.min(e,Math.max(0,Math.round(t.zoom_xmin*n)-r)),o.xmax=Math.min(e,Math.max(0,Math.round(t.zoom_xmax*n)-r))),t.zoom_ymin!==t.zoom_ymax&&(o.ymin=Math.min(a,Math.max(0,Math.round(t.zoom_ymin*s)-f)),o.ymax=Math.min(a,Math.max(0,Math.round(t.zoom_ymax*s)-f))),o}async makeUrlFromPngBuf(t,i){const e=t.fPngBuf;let a="";if(z(e))a=e;else for(let f=0;f<e.length;++f)a+=String.fromCharCode(e[f]<0?256+e[f]:e[f]);const o={url:"data:image/png;base64,"+N(a),constRatio:t.fConstRatio,can_zoom:i&&!p()},r=v();return!o.can_zoom||i?.zoom_xmin===i?.zoom_xmax&&i?.zoom_ymin===i?.zoom_ymax?o:new Promise(f=>{const n=r.createElement("img");n.onload=()=>{const s=r.createElement("canvas");s.width=n.width,s.height=n.height;const h=s.getContext("2d");h.drawImage(n,0,0);const m=h.getImageData(0,0,n.width,n.height).data,l=this.getImageZoomRange(i,o.constRatio,n.width,n.height),g=r.createElement("canvas");g.width=l.xmax-l.xmin,g.height=l.ymax-l.ymin;const d=g.getContext("2d"),u=d.getImageData(0,0,g.width,g.height),c=u.data;for(let b=l.ymin;b<l.ymax;++b){let x=(l.ymax-b-1)*(l.xmax-l.xmin)*4,P=((n.height-b-1)*n.width+l.xmin)*4;for(let C=l.xmin;C<l.xmax;++C)c[x++]=m[P++],c[x++]=m[P++],c[x++]=m[P++],c[x++]=m[P++]}d.putImageData(u,0,0),o.url=g.toDataURL(),f(o)},n.onerror=()=>f(o),n.src=o.url})}get _wheel_zoomy(){return!0}async drawImage(){const t=this.getObject(),i=this.getFramePainter(),e=i?.getFrameRect()??this.getPadPainter().getPadRect();t._blob&&(t._blob.length===15&&!t._blob[0]?(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:O,fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!==t.fImgBuf.length||t.fPalette.fNumPoints!==t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)):t._blob.length===3&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!==t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`),delete t._blob);let a;return t.fImgBuf&&t.fPalette?a=this.makeUrlFromImageBuf(t,i):t.fPngBuf?a=this.makeUrlFromPngBuf(t,i):a=Promise.resolve(null),a.then(o=>{if(!o?.url)return this;const r=this.createG(i).append("image").attr("href",o.url).attr("width",e.width).attr("height",e.height).attr("preserveAspectRatio",o.constRatio?null:"none");return this.isBatchMode()||((y.MoveResize||y.ContextMenu)&&r.style("pointer-events","visibleFill"),o.can_zoom&&r.style("cursor","pointer")),A(this,Z),!i||!o.can_zoom?this:this.drawColorPalette(this.getOptions().Zscale,!0).then(()=>(i.setAxesRanges(_(w),0,1,_(w),0,1,null,0,0),i.createXY({ndim:2,check_pad_range:!1}),i.addInteractivity()))})}fillContextMenuItems(t){const i=this.getObject(),e=this.getOptions();i&&t.addchk(i.fConstRatio,"Const ratio",a=>{i.fConstRatio=a,this.interactiveRedraw("pad",`exec:SetConstRatio(${a})`)},"Change const ratio flag of image"),i?.fPalette&&t.addchk(e.Zscale,"Color palette",a=>{e.Zscale=a,this.drawColorPalette(a,!0)},"Toggle color palette")}canZoomInside(t,i,e){return this.getObject()?(t==="x"||t==="y")&&e-i>.01:!1}getHistPalette(){return!0}async drawColorPalette(t,i){if(!this.isMainPainter())return null;if(!this.draw_palette){const o=_(T);Object.assign(o,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),o.fAxis.fChopt="+",this.draw_palette=o}let e=this.getPadPainter().findPainterFor(this.draw_palette);if(!t)return e&&(e.Enabled=!1,e.removeG()),null;const a=this.getFramePainter();if(i&&a){const o=this.draw_palette;o.fX2NDC=a.fX2NDC+.01+(o.fX2NDC-o.fX1NDC),o.fX1NDC=a.fX2NDC+.01,o.fY1NDC=a.fY1NDC,o.fY2NDC=a.fY2NDC}return e?(e.Enabled=!0,e.drawPave("")):F.draw(this.getPadPainter(),this.draw_palette).then(o=>{e=o,e.setSecondaryId(this),e.redraw=function(){}})}toggleColz(){if(this.getObject()?.fPalette){const t=this.getOptions();return t.Zscale=!t.Zscale,this.drawColorPalette(t.Zscale,!0)}}redraw(){return this.drawImage()}clickButton(t){return this.isMainPainter()&&t==="ToggleColorZ"?this.toggleColz():!1}fillToolbar(){const t=this.getPadPainter();t&&this.getObject()?.fPalette&&(t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}static async draw(t,i,e){const a=new I(t,i,e);return a.setAsMainPainter(),a.decodeOptions(e),k(a,!1).then(()=>a.drawImage()).then(()=>(a.fillToolbar(),a))}}export{I as TASImagePainter};
