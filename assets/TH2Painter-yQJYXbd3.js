import{l as R,n as N,az as k,aA as Z,aB as V,T as y,H as j}from"./index-DAa9yKAB.js";import{e as I,f as K,g as U,d as W,b as X}from"./hist3d-BC5Tno_J.js";import{T as $}from"./THistPainter-DJAmNO-k.js";import{T as q}from"./TH2Painter-Ba0oelVz.js";import"./latex3d-BISPawP1.js";import"./TPavePainter-DMWA3hUD.js";function J(g){const s=g.getHisto(),e=g.getFramePainter(),h=e.z_handle.getScaleMin(),i=e.z_handle.getScaleMax(),m=s.fBins.arr.length,l=e.grz(h);let z,c,b,d;g.maxbin=g.gmaxbin,g.minbin=g.gminbin,g.minposbin=g.gminposbin;const Y=g.getContour(!0),E=g.getHistPalette();for(b=0;b<m;++b){if(c=s.fBins.arr[b],c.fContent<h||(z=Y.getPaletteIndex(E,c.fContent),z===null)||c.fXmin>e.scale_xmax||c.fXmax<e.scale_xmin||c.fYmin>e.scale_ymax||c.fYmax<e.scale_ymin)continue;d=e.grz(c.fContent>i?i:c.fContent);const T=[],L=[];let v=1,x=c.fPoly,F=0;x._typename===V&&(v=c.fPoly.fGraphs.arr.length,x=null);for(let u=0;u<v;++u){(!x||u>0)&&(x=c.fPoly.fGraphs.arr[u]);const f=x.fX,w=x.fY;let r=x.fNpoints;for(;r>2&&f[0]===f[r-1]&&w[0]===w[r-1];)--r;let a,o;for(let _=0;_<2;++_){let P,D,H,C,M=e.size_x3d*e.size_z3d;const O=_>0?0:M/1e6;a=[],o=null;for(let B=0;B<r;++B)H=e.grx(f[B]),C=e.gry(w[B]),B>0&&(M=(H-P)**2+(C-D)**2),M>O&&(a.push(new y.Vector2(H,C)),P=H,D=C);try{a.length>2&&(o=y.ShapeUtils.triangulateShape(a,[]))}catch{o=null}if(o&&o.length>a.length-3)break}o?.length&&a&&(T.push(a),L.push(o),F+=o.length*2,d>l&&(F+=a.length*2))}const n=new Float32Array(F*9);let t=0;for(let u=0;u<T.length;++u){const f=T[u],w=L[u];for(let r=0;r<2;++r)for(let a=0;a<w.length;++a){const o=w[a],_=f[o[0]],P=f[o[r===0?2:1]],D=f[o[r===0?1:2]];n[t]=_.x,n[t+1]=_.y,n[t+2]=r?d:l,t+=3,n[t]=P.x,n[t+1]=P.y,n[t+2]=r?d:l,t+=3,n[t]=D.x,n[t+1]=D.y,n[t+2]=r?d:l,t+=3}if(d>l)for(let r=0;r<f.length;++r){const a=f.at(r),o=f.at(r>0?r-1:-1);n[t]=a.x,n[t+1]=a.y,n[t+2]=l,t+=3,n[t]=o.x,n[t+1]=o.y,n[t+2]=l,t+=3,n[t]=o.x,n[t+1]=o.y,n[t+2]=d,t+=3,n[t]=a.x,n[t+1]=a.y,n[t+2]=l,t+=3,n[t]=o.x,n[t+1]=o.y,n[t+2]=d,t+=3,n[t]=a.x,n[t+1]=a.y,n[t+2]=d,t+=3}}const S=new y.BufferGeometry;S.setAttribute("position",new y.BufferAttribute(n,3)),S.computeVertexNormals();const G=new y.MeshBasicMaterial(j(g.getHistPalette()?.getColor(z),{vertexColors:!1,side:y.DoubleSide})),p=new y.Mesh(S,G);e.add3DMesh(p),p.painter=g,p.bins_index=b,p.draw_z0=l,p.draw_z1=d,p.tip_color=65280,p.tooltip=function(){const u=this.painter,f=u.getObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:e.grx(f.fXmin),x2:e.grx(f.fXmax),y1:e.gry(f.fYmin),y2:e.gry(f.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:u.getPolyBinTooltips(this.bins_index)}}}}class A extends q{checkRangeFor3D(s){const e=this.getPadPainter()?.getRootPad(!0),h=e?.fLogv??e?.fLogz;let i=1;return s.ohmin&&s.ohmax?(this.zmin=s.hmin,this.zmax=s.hmax):s.minimum!==R&&s.maximum!==R?(this.zmin=s.minimum,this.zmax=s.maximum):(this.draw_content||this.gmaxbin)&&(this.zmin=h?this.gminposbin*.3:this.gminbin,this.zmax=this.gmaxbin,i=1+2*N.fHistTopMargin),h&&this.zmin<=0&&(this.zmin=this.zmax*1e-5),this.createHistDrawAttributes(!0),i}draw3DBins(s){this.isTH2Poly()?J(this):s.Contour?I(this,!0):s.Surf?K(this):s.Error?U(this):W(this)}async draw3D(s){this.mode3d=!0;const e=this.getFramePainter(),h=this.isMainPainter(),i=this.getOptions();let m=Promise.resolve(!0),l=!0;if(s==="resize"){const z=h?e.resize3D():!1;z!==1&&(l=!1,z&&e.render3D())}return l&&(i.zmult=this.checkRangeFor3D(i),h&&(m=X(this,k,i.Render3D)),e.mode3d&&(m=m.then(()=>{this.draw_content?this.draw3DBins(i):i.Axis&&i.Zscale&&(this.getContourLevels(!0),this.getHistPalette()),e.render3D(),this.updateStatWebCanvas(),e.addKeysHandler()}))),h&&(m=m.then(()=>this.drawColorPalette(i.Zscale&&(i.Lego===12||i.Lego===14||i.Surf===11||i.Surf===12)))),m.then(()=>this.updateFunctions()).then(()=>this.updateHistTitle()).then(()=>this)}static async build3d(s,e,h){const i=new A(null,s);i.decodeOptions(e);const m=i.getOptions();i.isTH2Poly()&&(m.Lego=12),i.scanContent(),m.zmult=i.checkRangeFor3D(m);const l=new Z(null,null);return i.getFramePainter=()=>l,X(i,k).then(()=>(i.draw_content&&i.draw3DBins(m),h?i:l.create3DScene(-1,!0)))}static async draw(s,e,h){return $._drawHist(new A(s,e),h)}}export{A as TH2Painter};
