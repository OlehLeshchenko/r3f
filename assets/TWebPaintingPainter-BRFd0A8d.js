import{O as P,a3 as S,N as m,a as w,a4 as B}from"./index-DAa9yKAB.js";class M extends P{updateObject(e){return this.matchObjectType(e)?(this.assignObject(e),!0):!1}getMenuHeader(){return this.getObject()?.fClassName||"TWebPainting"}fillContextMenu(e){const t=this.getMenuHeader();return e.header(t,`${S}${t}.html`),!0}handleMouseClick(e){const t=this.getPadPainter(),n=t?.getPadRect();if(t&&n&&this.getSnapId()){const a=m(e,this.getG().node());t.selectObjectPainter(this,{x:a[0]+n.x,y:a[1]+n.y})}}async redraw(){const e=this.getObject(),t=this.getAxisToSvgFunc();if(!e?.fOper||!t)return this;let n=0,a={},x=null,y="none",g="",u,p,i;const b=this.createG(),o=e.fOper.split(";"),l=r=>{if(r!==y&&(x&&(x.attr("d",g),g="",x=null,y="none"),!!r))switch(y=r,x=b.append("svg:path").attr("d",""),r){case"f":x.call(this.fillatt.func);break;case"l":x.call(this.lineatt.func).style("fill","none");break;case"m":x.call(this.markeratt.func);break}},T=(r,h)=>{let s=0;const c={_typename:"any"};for(let f=0;f<h.length;++f){const d=r.indexOf(":",s+1);c[h[f]]=parseInt(r.slice(s+1,d>s?d:void 0)),s=d}return c},C=r=>{for(;++r<o.length;)switch(u=o[r][0],u){case"z":this.createAttLine({attr:T(o[r],["fLineColor","fLineStyle","fLineWidth"]),force:!0}),l();continue;case"y":this.createAttFill({attr:T(o[r],["fFillColor","fFillStyle"]),force:!0}),l();continue;case"x":this.createAttMarker({attr:T(o[r],["fMarkerColor","fMarkerStyle","fMarkerSize"]),force:!0}),l();continue;case"o":a=T(o[r],["fTextColor","fTextFont","fTextSize","fTextAlign","fTextAngle"]),a.fTextSize<0&&(a.fTextSize*=-.001),l();continue;case"r":case"b":{l(u==="b"?"f":"l");const h=t.x(e.fBuf[n++]),s=t.y(e.fBuf[n++]),c=t.x(e.fBuf[n++]),f=t.y(e.fBuf[n++]);g+=`M${h},${s}h${c-h}v${f-s}h${h-c}z`;continue}case"l":case"f":{for(l(u),p=parseInt(o[r].slice(1)),i=0;i<p;++i)g+=`${i>0?"L":"M"}${t.x(e.fBuf[n++])},${t.y(e.fBuf[n++])}`;u==="f"&&(g+="Z");continue}case"m":{for(l(u),p=parseInt(o[r].slice(1)),this.markeratt.resetPos(),i=0;i<p;++i)g+=this.markeratt.create(t.x(e.fBuf[n++]),t.y(e.fBuf[n++]));continue}case"h":case"t":{if(a.fTextSize){l();const h=a.fTextSize>1?a.fTextSize:this.getPadPainter().getPadHeight()*a.fTextSize,s=b.append("svg:g");return this.startTextDrawingAsync(a.fTextFont,h,s).then(()=>{let c=o[r].slice(1),f=a.fTextAngle;if(f>=360&&(f-=Math.floor(f/360)*360),u==="h"){let d="";for(i=0;i<c.length;i+=2)d+=String.fromCharCode(parseInt(c.slice(i,i+2),16));c=d}return this.drawText({align:a.fTextAlign,x:t.x(e.fBuf[n++]),y:t.y(e.fBuf[n++]),rotate:-f,text:c,color:B(a.fTextColor),latex:0,draw_g:s}),this.finishTextDrawing(s)}).then(()=>C(r))}continue}default:console.log(`unsupported operation ${u}`)}return Promise.resolve(!0)};return C(-1).then(()=>(l(),w(this),this.isBatchMode()||b.on("click",r=>this.handleMouseClick(r)),this))}static async draw(e,t){const n=new M(e,t);return n.addToPadPrimitives(),n.redraw()}}export{M as TWebPaintingPainter};
