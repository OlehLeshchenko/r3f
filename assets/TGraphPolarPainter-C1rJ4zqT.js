import{M as S,D as v,m as _,N as $,Q as L,a as E,K as T,R as N,e as C,O as F,J as R,j as O,S as M,U as P,B as Y,n as k,V as G}from"./index-DAa9yKAB.js";import{TPavePainter as X,kPosTitle as j}from"./TPavePainter-DMWA3hUD.js";const A=Y(17);class z extends S{constructor(t,e,a){super(t,e,a),this.$polargram=!0,this.zoom_rmin=this.zoom_rmax=0,this.t0=0,this.mult=1,this.decodeOptions(a),this.setTooltipEnabled(!0)}isNormalAngles(){const t=this.getObject();return t?.fRadian||t?.fGrad||t?.fDegree}decodeOptions(t){const e=new v(t);this.setOptions({rdot:e.check("RDOT"),rangle:e.check("RANGLE",!0)?e.partAsInt():0,NoLabels:e.check("N"),OrthoLabels:e.check("O")}),this.storeDrawOpt(t)}setAnglesRange(t,e,a){if(t>=e&&(e=t+1),a){const r=this.getObject();r.fRwtmin=t,r.fRwtmax=e}this.t0=t,this.mult=2*Math.PI/(e-t)}translate(t,e,a){const r=(t-this.t0)*this.mult;let i=this.r(e),s=i/this.szx*this.szy,o=i*Math.cos(-r),l=s*Math.sin(-r);return a||(o=Math.round(o),l=Math.round(l),i=Math.round(i),s=Math.round(s)),{grx:o,gry:l,rx:i,ry:s}}format(t){return t===Math.round(t)?t.toString():this.ndig>10?t.toExponential(4):t.toFixed(this.ndig>0?this.ndig:0)}axisAsText(t,e){return t==="r"?e===Math.round(e)?e.toString():this.ndig>10?e.toExponential(4):e.toFixed(this.ndig+2):(e*=180/Math.PI,e===Math.round(e)?e.toString():e.toFixed(1))}getFrameRect(){const t=this.getPadPainter(),e=t.getRootPad(!0),a=t.getPadWidth(),r=t.getPadHeight(),i={};return e?(i.szx=Math.round(Math.max(.1,.5-Math.max(e.fLeftMargin,e.fRightMargin))*a),i.szy=Math.round(Math.max(.1,.5-Math.max(e.fBottomMargin,e.fTopMargin))*r)):(i.szx=Math.round(.5*a),i.szy=Math.round(.5*r)),i.width=2*i.szx,i.height=2*i.szy,i.x=Math.round(a/2-i.szx),i.y=Math.round(r/2-i.szy),i.hint_delta_x=i.szx,i.hint_delta_y=i.szy,i.transform=_(i.x,i.y)||"",i}mouseEvent(t,e){let a=null;if(t!=="leave"){const r=$(e,this.getG()?.node());a={x:r[0],y:r[1],touch:!1}}this.processFrameTooltipEvent(a)}mouseWheel(t){t.stopPropagation(),t.preventDefault(),this.processFrameTooltipEvent(null);const e=this.getObject();if(!e)return;let a=t.wheelDelta?-t.wheelDelta:t.deltaY||t.detail;if(!a)return;a=a<0?-.2:.2;let r=this.scale_rmin,i=this.scale_rmax;const s=i-r;i+=a*s,(r<e.fRwrmin||i>e.fRwrmax)&&(r=i=0),(this.zoom_rmin!==r||this.zoom_rmax!==i)&&(this.zoom_rmin=r,this.zoom_rmax=i,this.redrawPad())}mouseDoubleClick(){(this.zoom_rmin||this.zoom_rmax)&&(this.zoom_rmin=this.zoom_rmax=0,this.redrawPad())}async drawPolarLabels(t,e){const a=Math.round(t.fPolarTextSize*this.szy*2),r=this.getOptions();return this.startTextDrawingAsync(t.fPolarLabelFont,a).then(()=>{const i=e===8?["0","#frac{#pi}{4}","#frac{#pi}{2}","#frac{3#pi}{4}","#pi","#frac{5#pi}{4}","#frac{3#pi}{2}","#frac{7#pi}{4}"]:["0","#frac{2#pi}{3}","#frac{4#pi}{3}"],s=[12,11,21,31,32,33,23,13];for(let o=0;o<e;++o){const l=-o*2*Math.PI/e;this.getG().append("svg:path").attr("d",`M0,0L${Math.round(this.szx*Math.cos(l))},${Math.round(this.szy*Math.sin(l))}`).call(this.lineatt.func);let n=12,h=0;if(r.OrthoLabels)h=-o/e*360,h>-271&&h<-91&&(n=32,h+=180);else{const f=Math.round(16-l/Math.PI*4)%8;n=s[f]}this.drawText({align:n,rotate:h,x:Math.round((this.szx+a)*Math.cos(l)),y:Math.round((this.szy+a/this.szx*this.szy)*Math.sin(l)),text:i[o],color:this.getColor(t.fPolarLabelColor),latex:1})}return this.finishTextDrawing()})}async redraw(){if(!this.isMainPainter())return;const t=this.getObject(),e=this.getOptions(),a=this.getPadPainter().getFrameRect(),r=this.createG();_(r,Math.round(a.x+a.width/2),Math.round(a.y+a.height/2)),this.szx=a.szx,this.szy=a.szy,this.scale_rmin=t.fRwrmin,this.scale_rmax=t.fRwrmax,this.zoom_rmin!==this.zoom_rmax&&(this.scale_rmin=this.zoom_rmin,this.scale_rmax=this.zoom_rmax),this.r=L().domain([this.scale_rmin,this.scale_rmax]).range([0,this.szx]),t.fRadian?(t.fRwtmin=0,t.fRwtmax=2*Math.PI):t.fDegree?(t.fRwtmin=0,t.fRwtmax=360):t.fGrad&&(t.fRwtmin=0,t.fRwtmax=200),this.setAnglesRange(t.fRwtmin,t.fRwtmax);const i=this.r.ticks(5);let s=Math.floor(t.fNdivRad%1e4/100),o=t.fNdivPol%100;o!==3&&(o=8),this.createAttLine({attr:t}),this.gridatt||(this.gridatt=this.createAttLine({color:t.fLineColor,style:2,width:1,std:!1}));const l=Math.abs(t.fRwrmax-t.fRwrmin);this.ndig=l<=0?-3:Math.round(Math.log10(i.length/l));let n=[],h=0;for(;h<i.length;){const g=this.format(i[h]);if(n.indexOf(g)>=0){if(++this.ndig>10)break;n=[],h=0;continue}n.push(g),h++}let f=!1;const c=this.isBatchMode()?null:"visibleFill";return i.at(-1)<t.fRwrmax&&this.zoom_rmin===this.zoom_rmax&&(i.push(t.fRwrmax),f=!0),this.startTextDrawingAsync(t.fRadialLabelFont,Math.round(t.fRadialTextSize*this.szy*2)).then(()=>{const g=-(e.rangle||t.fAxisAngle)/180*Math.PI,d=Math.cos(g),y=Math.sin(g);for(let p=0;p<i.length;++p){let u=this.r(i[p]),x=u/this.szx*this.szy;if(r.append("ellipse").attr("cx",0).attr("cy",0).attr("rx",Math.round(u)).attr("ry",Math.round(x)).style("fill","none").style("pointer-events",c).call(this.lineatt.func),p<i.length-1||!f){const w=d>.7?1:d>0?3:d>-.7?1:3,m=Math.abs(d)<.7?1:3;this.drawText({align:10*w+m,x:Math.round(u*d),y:Math.round(x*y),text:this.format(i[p]),color:this.getColor(t.fRadialLabelColor),latex:0}),e.rdot&&r.append("ellipse").attr("cx",Math.round(u*d)).attr("cy",Math.round(x*y)).attr("rx",3).attr("ry",3).style("fill","red")}if(s>1&&(p<i.length-1||!f)){const w=(i[1]-i[0])/s;for(let m=1;m<s;++m){const b=i[p]+w*m;if(b>this.scale_rmax)break;u=this.r(b),x=u/this.szx*this.szy,r.append("ellipse").attr("cx",0).attr("cy",0).attr("rx",Math.round(u)).attr("ry",Math.round(x)).style("fill","none").style("pointer-events",c).call(this.gridatt.func)}}}return d<.999&&r.append("path").attr("d",`M0,0L${Math.round(this.szx*d)},${Math.round(this.szy*y)}`).style("pointer-events",c).call(this.lineatt.func),this.finishTextDrawing()}).then(()=>e.NoLabels?!0:this.drawPolarLabels(t,o)).then(()=>{if(s=Math.floor(t.fNdivPol%1e4/100),s>1)for(let g=0;g<o*s;++g){if(g%s===0)continue;const d=-g*2*Math.PI/o/s;r.append("svg:path").attr("d",`M0,0L${Math.round(this.szx*Math.cos(d))},${Math.round(this.szy*Math.sin(d))}`).call(this.gridatt.func)}this.isBatchMode()||(E(this,G),this.assignZoomHandler(r))})}fillContextMenuItems(t){const e=this.getObject(),a=this.getOptions();t.sub("Axis range"),t.addchk(e.fRadian,"Radian",r=>{e.fRadian=r,e.fDegree=e.fGrad=!1,this.interactiveRedraw("pad",r?"exec:SetToRadian()":"exec:SetTwoPi()")},"Handle data angles as radian range 0..2*Pi"),t.addchk(e.fDegree,"Degree",r=>{e.fDegree=r,e.fRadian=e.fGrad=!1,this.interactiveRedraw("pad",r?"exec:SetToDegree()":"exec:SetTwoPi()")},"Handle data angles as degree range 0..360"),t.addchk(e.fGrad,"Grad",r=>{e.fGrad=r,e.fRadian=e.fDegree=!1,this.interactiveRedraw("pad",r?"exec:SetToGrad()":"exec:SetTwoPi()")},"Handle data angles as grad range 0..200"),t.endsub(),t.addSizeMenu("Axis angle",0,315,45,a.rangle||e.fAxisAngle,r=>{a.rangle=e.fAxisAngle=r,this.interactiveRedraw("pad",`exec:SetAxisAngle(${r})`)})}assignZoomHandler(t){t.on("mouseenter",e=>this.mouseEvent("enter",e)).on("mousemove",e=>this.mouseEvent("move",e)).on("mouseleave",e=>this.mouseEvent("leave",e)),T.Zooming&&t.on("dblclick",e=>this.mouseDoubleClick(e)),T.Zooming&&T.ZoomWheel&&t.on("wheel",e=>this.mouseWheel(e))}static async draw(t,e,a){const r=N(t);if(r){if(r.getObject()===e)return r;throw Error("Cannot superimpose TGraphPolargram with any other drawings")}const i=new z(t,e,a);return C(i,!1).then(()=>(i.setAsMainPainter(),i.redraw())).then(()=>i)}}class D extends F{decodeOptions(t){const e=new v(t||"L"),a=e.check("RDOT"),r=e.check("RANGLE",!0)?e.partAsInt():0,i=this.setOptions({mark:e.check("P"),err:e.check("E"),fill:e.check("F"),line:e.check("L"),curve:e.check("C"),radian:e.check("R"),degree:e.check("D"),grad:e.check("G"),Axis:e.check("N")?"N":""},t);e.check("O")&&(i.Axis+="O"),a&&(i.Axis+="_rdot"),r&&(i.Axis+=`_rangle${r}`),this.storeDrawOpt(t)}updateObject(t,e){return this.matchObjectType(t)?(e&&e!==this.getOptions().original&&this.decodeOptions(e),this._draw_axis&&t.fPolargram&&this.getMainPainter().updateObject(t.fPolargram),delete t.fPolargram,Object.assign(this.getObject(),t),!0):!1}redraw(){return this.drawGraphPolar().then(()=>this.updateTitle())}async drawGraphPolar(){const t=this.getObject(),e=this.getOptions(),a=this.getMainPainter();if(!t||!a?.$polargram)return;e.mark&&this.createAttMarker({attr:t}),(e.err||e.line||e.curve)&&this.createAttLine({attr:t}),e.fill&&this.createAttFill({attr:t});const r=this.createG();if(this._draw_axis&&!a.isNormalAngles()){const n=t.fEX?.length;let h=t.fX[0],f=t.fX[0];for(let c=0;c<t.fNpoints;++c)h=Math.min(h,t.fX[c]-(n?t.fEX[c]:0)),f=Math.max(f,t.fX[c]+(n?t.fEX[c]:0));f+=(f-h)/t.fNpoints,a.setAnglesRange(h,f,!0)}r.attr("transform",a.getG().attr("transform"));let i="",s="";const o=[],l=this.isBatchMode()?null:"visibleFill";for(let n=0;n<t.fNpoints;++n){if(t.fY[n]>a.scale_rmax)continue;if(e.err){const f=a.translate(t.fX[n],t.fY[n]-t.fEY[n]),c=a.translate(t.fX[n],t.fY[n]+t.fEY[n]),g=a.translate(t.fX[n]+t.fEX[n],t.fY[n]),d=a.translate(t.fX[n]-t.fEX[n],t.fY[n]);s+=`M${f.grx},${f.gry}L${c.grx},${c.gry}M${g.grx},${g.gry}A${d.rx},${d.ry},0,0,1,${d.grx},${d.gry}`}const h=a.translate(t.fX[n],t.fY[n]);e.mark&&(i+=this.markeratt.create(h.grx,h.gry)),(e.curve||e.line||e.fill)&&o.push(h)}if((e.fill||e.line)&&o.length){const n=R(o,{line:!0});e.fill&&r.append("svg:path").attr("d",n+"Z").style("pointer-events",l).call(this.fillatt.func),e.line&&r.append("svg:path").attr("d",n).style("fill","none").style("pointer-events",l).call(this.lineatt.func)}e.curve&&o.length&&r.append("svg:path").attr("d",R(o)).style("fill","none").style("pointer-events",l).call(this.lineatt.func),s&&r.append("svg:path").attr("d",s).style("fill","none").style("pointer-events",l).call(this.lineatt.func),i&&r.append("svg:path").attr("d",i).style("pointer-events",l).call(this.markeratt.func),this.isBatchMode()||(E(this,G),a.assignZoomHandler(r))}createPolargram(t){const e=this.getOptions();t.fPolargram||(t.fPolargram=O("TGraphPolargram"),e.radian?t.fPolargram.fRadian=!0:e.degree?t.fPolargram.fDegree=!0:e.grad&&(t.fPolargram.fGrad=!0));let a=t.fY[0]||0,r=a;const i=t.fEY?.length;for(let s=0;s<t.fNpoints;++s)a=Math.min(a,t.fY[s]-(i?t.fEY[s]:0)),r=Math.max(r,t.fY[s]+(i?t.fEY[s]:0));return t.fPolargram.fRwrmin=a-(r-a)*.1,t.fPolargram.fRwrmax=r+(r-a)*.1,t.fPolargram}extractTooltip(t){if(!t)return null;const e=this.getObject(),a=this.getMainPainter();let r=1e10,i=-1,s=null;for(let n=0;n<e.fNpoints;++n){const h=a.translate(e.fX[n],e.fY[n]),f=(h.grx-t.x)**2+(h.gry-t.y)**2;f<r&&(r=f,i=n,s=h)}let o=5;if(this.markeratt?.used&&(o=this.markeratt.getFullSize()),Math.sqrt(r)>o)return null;const l={name:this.getObject().fName,title:this.getObject().fTitle,x:s.grx,y:s.gry,color1:(this.markeratt?.used?this.markeratt.color:void 0)??(this.fillatt?.used?this.fillatt.color:void 0)??this.lineatt?.color,exact:Math.sqrt(r)<4,lines:[this.getObjectHint()],binindx:i,menu_dist:o,radius:o};return l.lines.push(`r = ${a.axisAsText("r",e.fY[i])}`,`phi = ${a.axisAsText("phi",e.fX[i])}`),e.fEY&&e.fEY[i]&&l.lines.push(`error r = ${a.axisAsText("r",e.fEY[i])}`),e.fEX&&e.fEX[i]&&l.lines.push(`error phi = ${a.axisAsText("phi",e.fEX[i])}`),l}async updateTitle(){if(!this._draw_axis)return this;const t=this.getPadPainter()?.findPainterFor(null,M,P),e=t?.getObject();if(!t||!e)return this;const a=this.getObject(),r=!a.TestBit(A)&&k.fOptTitle>0;return e.Clear(),r&&e.AddText(a.fTitle),t.redraw().then(()=>this)}async drawTitle(){if(!this._draw_axis)return this;const t=this.getObject(),e=k,a=!t.TestBit(A)&&e.fOptTitle>0,r=this.getPadPainter();let i=r.findInPrimitives(M,P);return i?(i.Clear(),a&&i.AddText(t.fTitle),this):(i=O(P),Object.assign(i,{fName:M,fFillColor:e.fTitleColor,fFillStyle:e.fTitleStyle,fBorderSize:e.fTitleBorderSize,fTextFont:e.fTitleFont,fTextSize:e.fTitleFontSize,fTextColor:e.fTitleTextColor,fTextAlign:22}),a&&i.AddText(t.fTitle),X.draw(r,i,j).then(s=>(s?.setSecondaryId(this,M),this)))}showTooltip(t){let e=this.getG()?.selectChild(".tooltip_bin");if(!t||!this.getG()){e?.remove();return}e.empty()&&(e=this.getG().append("svg:ellipse").attr("class","tooltip_bin").style("pointer-events","none")),t.changed=e.property("current_bin")!==t.binindx,t.changed&&e.attr("cx",t.x).attr("cy",t.y).attr("rx",Math.round(t.radius)).attr("ry",Math.round(t.radius)).style("fill","none").style("stroke",t.color1).property("current_bin",t.binindx)}processTooltipEvent(t){const e=this.extractTooltip(t);return(!t||!t.disabled)&&this.showTooltip(e),e}static async draw(t,e,a){const r=new D(t,e,a);r.decodeOptions(a);const i=r.getMainPainter();if(i&&!i.$polargram)return console.error("Cannot superimpose TGraphPolar with plain histograms"),null;let s=Promise.resolve(null);return i||(r._draw_axis=!0,s=z.draw(t,r.createPolargram(e),r.options.Axis)),s.then(o=>(o?.setSecondaryId(r,"polargram"),r.addToPadPrimitives(),r.drawGraphPolar())).then(()=>r.drawTitle())}}export{D as TGraphPolarPainter,z as TGraphPolargramPainter};
