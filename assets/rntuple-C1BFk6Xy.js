import{bE as E,al as D,ay as v,Y as B,u as z}from"./index-DAa9yKAB.js";const y=!0;class U{constructor(e){if(e instanceof ArrayBuffer)this.buffer=e,this.byteOffset=0,this.byteLength=e.byteLength;else if(ArrayBuffer.isView(e))this.buffer=e.buffer,this.byteOffset=e.byteOffset,this.byteLength=e.byteLength;else throw new TypeError("Invalid buffer type");this.view=new DataView(this.buffer),this.offset=this.byteOffset}seek(e){if(typeof e=="bigint"){if(e>BigInt(Number.MAX_SAFE_INTEGER))throw new Error(`Offset too large to seek safely: ${e}`);this.offset=Number(e)}else this.offset=e}readU8(){const e=this.view.getUint8(this.offset);return this.offset+=1,e}readU16(){const e=this.view.getUint16(this.offset,y);return this.offset+=2,e}readU32(){const e=this.view.getUint32(this.offset,y);return this.offset+=4,e}readS8(){const e=this.view.getInt8(this.offset);return this.offset+=1,e}readS16(){const e=this.view.getInt16(this.offset,y);return this.offset+=2,e}readS32(){const e=this.view.getInt32(this.offset,y);return this.offset+=4,e}readF32(){const e=this.view.getFloat32(this.offset,y);return this.offset+=4,e}readF64(){const e=this.view.getFloat64(this.offset,y);return this.offset+=8,e}readString(){const e=this.readU32();let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(this.readU8());return t}readU64(){const e=this.view.getBigUint64(this.offset,y);return this.offset+=8,e}readS64(){const e=this.view.getBigInt64(this.offset,y);return this.offset+=8,e}}const s={kBit:0,kByte:1,kChar:2,kInt8:3,kUInt8:4,kInt16:5,kUInt16:6,kInt32:7,kUInt32:8,kInt64:9,kUInt64:10,kReal16:11,kReal32:12,kReal64:13,kIndex32:14,kIndex64:15,kSplitInt16:17,kSplitUInt16:18,kSplitInt32:19,kSplitUInt32:20,kSplitInt64:21,kSplitUInt64:22,kSplitReal16:23,kSplitReal32:24,kSplitReal64:25,kSplitIndex32:26,kSplitIndex64:27};function N(r,e){const{coltype:t}=e;if(t===s.kSplitUInt16||t===s.kSplitUInt32||t===s.kSplitUInt64||t===s.kSplitReal16||t===s.kSplitReal32||t===s.kSplitReal64||t===s.kSplitIndex32||t===s.kSplitIndex64||t===s.kSplitInt16||t===s.kSplitInt32||t===s.kSplitInt64){let i;switch(t){case s.kSplitReal64:case s.kSplitInt64:case s.kSplitUInt64:case s.kSplitIndex64:i=8;break;case s.kSplitReal32:case s.kSplitInt32:case s.kSplitIndex32:case s.kSplitUInt32:i=4;break;case s.kSplitInt16:case s.kSplitUInt16:case s.kSplitReal16:i=2;break;default:throw new Error(`Unsupported split coltype: ${t} (0x${t.toString(16).padStart(2,"0")})`)}const a=new DataView(r.buffer,r.byteOffset,r.byteLength),c=r.byteLength/i,f=new ArrayBuffer(r.byteLength),n=new Uint8Array(f);for(let l=0;l<c;++l)for(let o=0;o<i;++o){const p=o*c+l,h=a.getUint8(p),m=l*i+o;n[m]=h}const d=f;let u;switch(t){case s.kSplitUInt16:u=s.kUInt16;break;case s.kSplitUInt32:u=s.kUInt32;break;case s.kSplitUInt64:u=s.kUInt64;break;case s.kSplitIndex32:u=s.kIndex32;break;case s.kSplitIndex64:u=s.kIndex64;break;case s.kSplitReal16:u=s.kReal16;break;case s.kSplitReal32:u=s.kReal32;break;case s.kSplitReal64:u=s.kReal64;break;case s.kSplitInt16:u=s.kInt16;break;case s.kSplitInt32:u=s.kInt32;break;case s.kSplitInt64:u=s.kInt64;break;default:throw new Error(`Unsupported split coltype for reassembly: ${t}`)}return{blob:d,coltype:u}}return{blob:r,coltype:t}}function R(r,e){let t,i;if(e===s.kIndex32)t=new Int32Array(r.buffer||r,r.byteOffset||0,r.byteLength/4),i=new Int32Array(t.length);else if(e===s.kIndex64)t=new BigInt64Array(r.buffer||r,r.byteOffset||0,r.byteLength/8),i=new BigInt64Array(t.length);else throw new Error(`DecodeDeltaIndex: unsupported column type ${e}`);t.length>0&&(i[0]=t[0]);for(let a=1;a<t.length;++a)i[a]=i[a-1]+t[a];return{blob:i,coltype:e}}function A(r,e){let t,i;if(e===s.kInt16)t=new Uint16Array(r.buffer||r,r.byteOffset||0,r.byteLength/2),i=new Int16Array(t.length);else if(e===s.kInt32)t=new Uint32Array(r.buffer||r,r.byteOffset||0,r.byteLength/4),i=new Int32Array(t.length);else if(e===s.kInt64)t=new BigUint64Array(r.buffer||r,r.byteOffset||0,r.byteLength/8),i=new BigInt64Array(t.length);else throw new Error(`decodeZigzag: unsupported column type ${e}`);for(let a=0;a<t.length;++a){const c=t[a];i[a]=c>>>1^-(c&1)}return{blob:i,coltype:e}}const T=1,$=2,_=4,O=1,P=2;class F{deserializeHeader(e){if(!e)return;const t=new U(e),i=t.offset,{envelopeLength:a}=this._readEnvelopeMetadata(t),c=i+a-8,f=t.offset;t.seek(c),this.headerEnvelopeChecksum=t.readU64(),t.seek(f),this._readFeatureFlags(t),this.name=t.readString(),this.description=t.readString(),this.writer=t.readString(),this._readSchemaDescription(t)}deserializeFooter(e){if(!e)return;const t=new U(e);if(this._readEnvelopeMetadata(t),this._readFeatureFlags(t),t.readU64()!==this.headerEnvelopeChecksum)throw new Error("RNTuple corrupted: header checksum does not match footer checksum.");if(t.readS64()<0)throw new Error("Schema extension frame is not a record frame, which is unexpected.");this._readSchemaDescription(t),this._readClusterGroups(t)}_readEnvelopeMetadata(e){const t=e.readU64(),i=Number(t&0xFFFFn),a=Number(t>>16n&0xFFFFFFFFFFFFn);return{envelopeType:i,envelopeLength:a}}_readSchemaDescription(e){const t=this._readFieldDescriptors(e),i=this._readColumnDescriptors(e),a=this._readAliasColumn(e),c=this._readExtraTypeInformation(e);this.fieldDescriptors=(this.fieldDescriptors||[]).concat(t),this.columnDescriptors=(this.columnDescriptors||[]).concat(i),this.aliasColumns=(this.aliasColumns||[]).concat(a),this.extraTypeInfo=(this.extraTypeInfo||[]).concat(c)}_readFeatureFlags(e){for(this.featureFlags=[];;){const t=e.readU64();if(this.featureFlags.push(t),(t&0x8000000000000000n)===0n)break}if(this.featureFlags.some(t=>t!==0n))throw new Error("Unexpected non-zero feature flags: "+this.featureFlags)}_readFieldDescriptors(e){const t=BigInt(e.offset),i=e.readS64();if(!(i<0))throw new Error("Field list frame is not a list frame, which is required.");const c=e.readU32(),f=[];for(let n=0;n<c;++n){const d=BigInt(e.offset),u=e.readS64(),l=e.readU32(),o=e.readU32(),p=e.readU32(),h=e.readU16(),m=e.readU16(),k=e.readString(),g=e.readString(),S=e.readString(),w=e.readString();let I=null,x=null,b=null;m&T&&(I=e.readU64()),m&$&&(x=e.readU32()),m&_&&(b=e.readU32()),f.push({fieldVersion:l,typeVersion:o,parentFieldId:p,structRole:h,flags:m,fieldName:k,typeName:g,typeAlias:S,description:w,arraySize:I,sourceFieldId:x,checksum:b}),e.seek(Number(d+u))}return e.seek(Number(t-i)),f}_readColumnDescriptors(e){const t=BigInt(e.offset),i=e.readS64();if(!(i<0))throw new Error("Column list frame is not a list frame, which is required.");const c=e.readU32(),f=[];for(let n=0;n<c;++n){const d=BigInt(e.offset),u=e.readS64(),l=e.readU16(),o=e.readU16(),p=e.readU32(),h=e.readU16(),m=e.readU16();let k=null,g=null,S=null;h&O&&(k=e.readU64()),h&P&&(g=e.readF64(),S=e.readF64());const w={coltype:l,bitsOnStorage:o,fieldId:p,flags:h,representationIndex:m,firstElementIndex:k,minValue:g,maxValue:S,index:n};w.isDeferred=function(){return(this.flags&F.kFlagDeferredColumn)!==0},w.isSuppressed=function(){return this.firstElementIndex!==null&&this.firstElementIndex<0},f.push(w),e.seek(Number(d+u))}return e.seek(Number(t-i)),f}_readAliasColumn(e){const t=BigInt(e.offset),i=e.readS64();if(!(i<0))throw new Error("Alias column list frame is not a list frame, which is required.");const c=e.readU32(),f=[];for(let n=0;n<c;++n){const d=BigInt(e.offset),u=e.readS64(),l=e.readU32(),o=e.readU32();f.push({physicalColumnId:l,fieldId:o}),e.seek(Number(d+u))}return e.seek(Number(t-i)),f}_readExtraTypeInformation(e){const t=BigInt(e.offset),i=e.readS64();if(!(i<0))throw new Error("Extra type info frame is not a list frame, which is required.");const c=e.readU32(),f=[];for(let n=0;n<c;++n){const d=BigInt(e.offset),u=e.readS64(),l=e.readU32(),o=e.readU32();f.push({contentId:l,typeVersion:o}),e.seek(Number(d+u))}return e.seek(Number(t-i)),f}_readClusterGroups(e){const t=BigInt(e.offset),i=e.readS64();if(!(i<0))throw new Error("Cluster group frame is not a list frame");const c=e.readU32(),f=[];for(let n=0;n<c;++n){const d=BigInt(e.offset),u=e.readS64(),l=e.readU64(),o=e.readU64(),p=e.readU32(),h=e.readU64(),m=this._readLocator(e),k={minEntry:l,entrySpan:o,numClusters:p,pageListLocator:m,pageListLength:h};f.push(k),e.seek(Number(d+u))}e.seek(Number(t-i)),this.clusterGroups=f}_readLocator(e){const t=e.readU32();if((t|0)<0)throw new Error("Non-standard locators (T=1) not supported yet");const i=t,a=e.readU64();return{size:i,offset:a}}deserializePageList(e){if(!e)throw new Error("deserializePageList: received an invalid or empty page list blob");const t=new U(e);if(this._readEnvelopeMetadata(t),t.readU64()!==this.headerEnvelopeChecksum)throw new Error("RNTuple corrupted: header checksum does not match Page List Header checksum.");const a=BigInt(t.offset),c=t.readS64();if(c>=0)throw new Error("Expected a list frame for cluster summaries");const f=t.readU32(),n=[];for(let d=0;d<f;++d){const u=BigInt(t.offset),l=t.readS64(),o=t.readU64(),p=t.readU64(),h=p>>56n;if(h&0x01n)throw new Error("Cluster summary uses unsupported sharded flag (0x01)");const m=Number(p&0x00FFFFFFFFFFFFFFn);n.push({firstEntry:o,numEntries:m,flags:h}),t.seek(Number(u+l))}t.seek(Number(a-c)),this.clusterSummaries=n,this._readNestedFrames(t),t.readU64()}_readNestedFrames(e){const t=[];if(e.readS64()>=0)throw new Error("Expected list frame for clusters");const a=e.readU32();for(let c=0;c<a;++c){if(e.readS64()>=0)throw new Error("Expected outer list frame for columns");const n=e.readU32(),d=[];for(let u=0;u<n;++u){if(e.readS64()>=0)throw new Error("Expected inner list frame for pages");const o=e.readU32(),p=[];for(let g=0;g<o;++g){const S=e.readS32(),w=S<0,I=BigInt(Math.abs(Number(S))),x=this._readLocator(e);p.push({numElements:I,hasChecksum:w,locator:x})}const h=e.readS64(),m=h<0;let k=null;m||(k=e.readU32()),d.push({pages:p,elementOffset:h,isSuppressed:m,compression:k})}t.push(d)}this.pageLocations=t}deserializePage(e,t,i){const a=t.coltype,{coltype:c}=N(e,t);let{blob:f}=N(e,t);if(a===s.kSplitIndex32||a===s.kSplitIndex64){const{blob:o}=R(f,c);f=o}if(a===s.kSplitInt16||a===s.kSplitInt32||a===s.kSplitInt64){const{blob:o}=A(f,c);f=o}const n=new U(f),d=[],u=Number(i.numElements),l=o=>{for(let p=0;p<u;++p)d.push(o())};switch(c){case s.kBit:{let o=0;const p=f.byteLength*8;if(p<u)throw new Error(`kBit: Not enough bits in buffer (${p}) for numValues (${u})`);for(let h=0;h<f.byteLength;++h){const m=n.readU8();for(let k=0;k<8&&o<u;++k,++o){const g=m>>>k&1,S=g===1;d.push(S)}}break}case s.kReal64:l(n.readF64.bind(n));break;case s.kReal32:l(n.readF32.bind(n));break;case s.kInt64:l(n.readS64.bind(n));break;case s.kUInt64:l(n.readU64.bind(n));break;case s.kInt32:l(n.readS32.bind(n));break;case s.kUInt32:l(n.readU32.bind(n));break;case s.kInt16:l(n.readS16.bind(n));break;case s.kUInt16:l(n.readU16.bind(n));break;case s.kInt8:l(n.readS8.bind(n));break;case s.kUInt8:case s.kByte:l(n.readU8.bind(n));break;case s.kChar:l(()=>String.fromCharCode(n.readS8()));break;case s.kIndex32:l(n.readS32.bind(n));break;case s.kIndex64:l(n.readS64.bind(n));break;default:throw new Error(`Unsupported column type: ${t.coltype}`)}return d}}async function L(r){return r?.builder?!0:r.$file?r.$file.readBuffer([r.fSeekHeader,r.fNBytesHeader,r.fSeekFooter,r.fNBytesFooter]).then(e=>{if(e?.length!==2)return!1;const t=(i,a)=>i.byteLength===a?Promise.resolve(i):E(i,a);return Promise.all([t(e[0],r.fLenHeader),t(e[1],r.fLenFooter)]).then(i=>{const[a,c]=i;if(!a||!c)return!1;r.builder=new F,r.builder.deserializeHeader(a),r.builder.deserializeFooter(c),r.fieldToColumns={};for(const l of r.builder.columnDescriptors){const o=r.builder.fieldDescriptors[l.fieldId],p=o.fieldName;r.fieldToColumns[p]||(r.fieldToColumns[p]=[]),r.fieldToColumns[p].push(l)}const f=r.builder.clusterGroups?.[0];if(!f||!f.pageListLocator)throw new Error("No valid cluster group or page list locator found");const n=Number(f.pageListLocator.offset),d=Number(f.pageListLocator.size),u=Number(f.pageListLength);return r.$file.readBuffer([n,d]).then(l=>{if(!(l instanceof DataView))throw new Error(`Expected DataView from readBuffer, got ${Object.prototype.toString.call(l)}`);return l.byteLength===u?(r.builder.deserializePageList(l),!0):E(l,u).then(o=>{if(!(o instanceof DataView))throw new Error(`Unzipped page list is not a DataView, got ${Object.prototype.toString.call(o)}`);return r.builder.deserializePageList(o),!0})})})}).catch(e=>{throw console.error("Error during readHeaderFooter execution:",e),e}):!1}function V(r,e,t){const i=r.builder,a=i.fieldDescriptors.find(f=>f.fieldName===e),c=r._clusterData[e];if(!a)throw new Error(`No descriptor for field ${e}`);if(!c)throw new Error(`No data for field ${e}`);if(Array.isArray(c)&&c.length===2){const[f,n]=c,d=t===0?0:Number(f[t-1]),u=Number(f[t]);return n.slice(d,u).join("")}return c[0][t]}function C(r,e){const t=r.getBranch(e);return B(t)?t:t?.fieldName}function H(r,e){const t=r.builder;if(!t.clusterSummaries||t.clusterSummaries.length===0)throw new Error("No cluster summaries available - possibly incomplete file reading");const i=e.currentCluster,a=t.clusterSummaries[i],c=[],f=[];for(let d=0;d<e.numBranches();++d)f.push(C(e,d));for(const d of f){const u=r.fieldToColumns[d];if(!u)throw new Error(`Selected field '${d}' not found in RNTuple`);for(const l of u){const o=t.pageLocations[i]?.[l.index];if(!o||!o.pages)throw new Error(`No pages for column ${l.index} in cluster ${i}`);for(const p of o.pages)c.push({page:p,colDesc:l,fieldName:d})}}if(e.currentCluster++,c.length===0)return e.Terminate(!1),Promise.resolve();const n=c.flatMap(d=>[Number(d.page.locator.offset),Number(d.page.locator.size)]);return r.$file.readBuffer(n).then(d=>{const u=Array.isArray(d)?d:[d],l=u.map((o,p)=>{const{page:h,colDesc:m}=c[p],k=t.pageLocations[i][m.index],g=Number(h.numElements),S=m.bitsOnStorage/8;if(k.compression===0)return Promise.resolve(o);const w=g*S;if(m.coltype===s.kBit){const I=Math.ceil(g/8);return o.byteLength===I?Promise.resolve(o):E(o,I).catch(x=>{throw new Error(`Failed to unzip boolean page ${p}: ${x.message}`)})}return o.byteLength===w?Promise.resolve(o):E(o,w).then(I=>I||o).catch(I=>{throw new Error(`Failed to unzip page ${p}: ${I.message}`)})});return Promise.all(l).then(o=>{r._clusterData={};for(let h=0;h<o.length;++h){const m=o[h];if(!(m instanceof DataView))throw new Error(`Invalid blob type for page ${h}: ${Object.prototype.toString.call(m)}`);const{page:k,colDesc:g}=c[h],S=t.fieldDescriptors[g.fieldId],w=t.deserializePage(m,g,k);if(r._clusterData[S.fieldName]||(r._clusterData[S.fieldName]=[]),S.typeName==="std::string")if(g.coltype===s.kIndex64||g.coltype===s.kIndex32||g.coltype===s.kSplitIndex64||g.coltype===s.kSplitIndex32)r._clusterData[S.fieldName][0]=w;else if(g.coltype===s.kChar)r._clusterData[S.fieldName][1]=w;else throw new Error(`Unsupported column type for string field: ${g.coltype}`);else r._clusterData[S.fieldName][0]=w}for(const h of f){const m=t.fieldDescriptors.find(g=>g.fieldName===h),k=r._clusterData[h];if(m.typeName==="std::string"){if(!Array.isArray(k)||k.length!==2)throw new Error(`String field '${h}' must have 2 columns`);if(k[0].length!==t.clusterSummaries[i].numEntries)throw new Error(`Malformed string field '${h}': missing final offset`)}}const p=a.numEntries;for(let h=0;h<p;++h){for(let m=0;m<e.numBranches();++m){const k=C(e,m),g=e.nameOfBranch(m);if(!r._clusterData[k])throw new Error(`Missing values for selected field: ${k}`);e.tgtobj[g]=V(r,k,h)}e.Process()}e.Terminate(!0)})})}function M(r,e,t){return L(r).then(()=>(e.Begin(),e.currentCluster=0,H(r,e))).then(()=>e)}class j extends v{getNumEntries(e){let t=0;return e?.builder.clusterSummaries.forEach(i=>{t+=i.numEntries}),t}findBranch(e,t){return e.builder?.fieldDescriptors.find(i=>i.fieldName===t)}isArrayBranch(){return!1}}async function q(r,e){return B(e)?e={expr:e}:z(e)||(e={}),e.SelectorClass=j,e.processFunction=M,L(r).then(t=>t?D(r,e):null)}async function Z(r,e){return r._childs=[],L(e).then(t=>t&&(e.builder?.fieldDescriptors.forEach(i=>{const a={_name:i.fieldName,_typename:"ROOT::RNTupleField",_kind:"ROOT::RNTupleField",_title:`Filed of type ${i.typeName}`,$tuple:e,$field:i};a._obj=a,r._childs.push(a)}),!0))}export{U as RBufferReader,V as readEntry,L as readHeaderFooter,q as rntupleDraw,M as rntupleProcess,Z as tupleHierarchy};
